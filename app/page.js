'use client';
import { useState, useEffect } from 'react';
import { createClient } from '@supabase/supabase-js';

const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL || '';
const supabaseKey = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY || '';
const supabase = supabaseUrl && supabaseKey ? createClient(supabaseUrl, supabaseKey) : null;

export default function TicketGrader() {
  const [ticketData, setTicketData] = useState(null);
  const [ticketMessages, setTicketMessages] = useState([]);
  const [agents, setAgents] = useState([]);
  const [isLoading, setIsLoading] = useState(true);
  const [isAnalyzing, setIsAnalyzing] = useState(false);
  const [analysisComplete, setAnalysisComplete] = useState(false);
  const [saveStatus, setSaveStatus] = useState('');
  const [activeTab, setActiveTab] = useState('grade');
  const [allEvaluations, setAllEvaluations] = useState([]);
  const [queueItems, setQueueItems] = useState([]);
  const [dateFilter, setDateFilter] = useState('all');
  const [customStartDate, setCustomStartDate] = useState('');
  const [customEndDate, setCustomEndDate] = useState('');
  const [agentFilter, setAgentFilter] = useState('all');
  const [evaluatorFilter, setEvaluatorFilter] = useState('all');
  const [historyDateFilter, setHistoryDateFilter] = useState('all');
  const [historyAgentFilter, setHistoryAgentFilter] = useState('all');
  const [historyEvaluatorFilter, setHistoryEvaluatorFilter] = useState('all');
  const [selectedEvaluation, setSelectedEvaluation] = useState(null);
  const [showEmailModal, setShowEmailModal] = useState(false);
  const [emailTo, setEmailTo] = useState('');
  const [evaluationToEmail, setEvaluationToEmail] = useState(null);
  const [coachingDateFilter, setCoachingDateFilter] = useState('all');
  const [coachingAgentFilter, setCoachingAgentFilter] = useState('all');
  const [selectedCoachingAgent, setSelectedCoachingAgent] = useState(null);
  const [coachingSessions, setCoachingSessions] = useState([]);
  const [showCoachingModal, setShowCoachingModal] = useState(false);
  const [coachingCoach, setCoachingCoach] = useState('');
  const [coachingNotes, setCoachingNotes] = useState('');
  const [coachingSaving, setCoachingSaving] = useState(false);
  const escalationAgents = ['JB','Arche','Princess','Cess','Analie','Randel','Ardylyn'];
  const evaluators = ['AI-QA','AI-Auto','Donna','Jamaica','Ara','Jen','Van','Karen','Victor'];
  const [currentAgentIndex, setCurrentAgentIndex] = useState(0);
  const [agentName, setAgentName] = useState('');
  const [isEscalationAgent, setIsEscalationAgent] = useState(false);
  const [evaluatorName, setEvaluatorName] = useState('');
  const [aiReasoning, setAiReasoning] = useState('');
  const [zeroToleranceViolation, setZeroToleranceViolation] = useState(false);
  const [violationNotes, setViolationNotes] = useState('');
  const [detectedBuzzwords, setDetectedBuzzwords] = useState([]);
  const [softSkills, setSoftSkills] = useState({tone:0,empathy:0,professionalism:0,clarity:0});
  const [softSkillsExp, setSoftSkillsExp] = useState({tone:'',empathy:'',professionalism:'',clarity:''});
  const [issueUnderstanding, setIssueUnderstanding] = useState({correctIdentification:0,rootCauseAnalysis:0,customerContext:0,escalationRecognition:0});
  const [issueUnderstandingExp, setIssueUnderstandingExp] = useState({correctIdentification:'',rootCauseAnalysis:'',customerContext:'',escalationRecognition:''});
  const [productProcess, setProductProcess] = useState({policyAccuracy:0,sopAdherence:0,solutionCorrectness:0,escalationProcess:0});
  const [productProcessExp, setProductProcessExp] = useState({policyAccuracy:'',sopAdherence:'',solutionCorrectness:'',escalationProcess:''});
  const [toolsUtilization, setToolsUtilization] = useState({gorgiasUsage:0,internalNotes:0,shopifyUsage:0});
  const [toolsUtilizationExp, setToolsUtilizationExp] = useState({gorgiasUsage:'',internalNotes:'',shopifyUsage:''});
  const [comments, setComments] = useState('');
  const [suggestedResponse, setSuggestedResponse] = useState('');
  const [agentEvaluations, setAgentEvaluations] = useState([]);
  const [pastEvaluations, setPastEvaluations] = useState([]);
  const [showPastDetail, setShowPastDetail] = useState(null);
  // Auth state
  const [user, setUser] = useState(null);
  const [userRole, setUserRole] = useState(null);
  const [userName, setUserName] = useState('');
  const [authLoading, setAuthLoading] = useState(true);
  // Dispute state
  const [disputes, setDisputes] = useState([]);
  const [disputeReason, setDisputeReason] = useState('');
  const [disputeEvaluation, setDisputeEvaluation] = useState(null);
  const [showDisputeModal, setShowDisputeModal] = useState(false);
  const [disputeSaving, setDisputeSaving] = useState(false);
  const [selectedDispute, setSelectedDispute] = useState(null);
  const [disputeReviewNotes, setDisputeReviewNotes] = useState('');
  const [disputeScores, setDisputeScores] = useState(null);
  const buzzwords = ['legal','lawyer','attorney','lawsuit','sue','court','chargeback','dispute charge','consumer affairs','consumer protection','ftc','federal trade','bbb','better business bureau','attorney general','small claims'];

  // Professional dark theme with blue-green bg and dark blue-gray cards
  const T = {
    bgGradient: 'linear-gradient(145deg, #0a1628 0%, #0d2137 18%, #0f2b3a 35%, #0e3340 50%, #103b3d 65%, #14443a 80%, #1a4d3e 100%)',
    // Cards - dark blue to gray gradient
    card: 'linear-gradient(135deg, #1a2744 0%, #1e2d4a 40%, #263448 70%, #2d3a4d 100%)',
    cardFlat: '#1e2d4a',
    cardInner: 'rgba(255,255,255,0.04)',
    cardHover: 'rgba(255,255,255,0.06)',
    // Borders
    border: 'rgba(255,255,255,0.08)',
    borderLight: 'rgba(255,255,255,0.05)',
    borderAccent: 'rgba(94,234,212,0.15)',
    // Text
    textPrimary: '#e2e8f0',
    textSecondary: '#94a3b8',
    textMuted: '#64748b',
    textAccent: '#5eead4',
    textWarm: '#fbbf24',
    // Accents
    teal: '#14b8a6',
    tealLight: '#5eead4',
    tealDark: '#0d9488',
    blue: '#3b82f6',
    blueLight: '#60a5fa',
    green: '#22c55e',
    amber: '#f59e0b',
    rose: '#f43f5e',
    slate: '#475569',
    // Functional
    success: '#22c55e',
    warning: '#f59e0b',
    danger: '#ef4444',
    info: '#3b82f6',
    // Input
    inputBg: 'rgba(255,255,255,0.06)',
    inputBorder: 'rgba(255,255,255,0.1)',
    inputText: '#e2e8f0',
    // Shadows
    shadow: '0 4px 24px rgba(0,0,0,0.3)',
    shadowLg: '0 8px 40px rgba(0,0,0,0.4)',
    // Tab
    tabActive: 'linear-gradient(135deg, #14b8a6 0%, #0d9488 100%)',
    tabInactive: 'rgba(255,255,255,0.06)',
    // Rating
    ratingOn: 'linear-gradient(135deg, #14b8a6 0%, #0d9488 100%)',
    ratingOff: 'rgba(255,255,255,0.08)',
  };

  const cardStyle = {background:T.card,borderRadius:'16px',border:`1px solid ${T.border}`,boxShadow:T.shadow};
  const inputStyle = {padding:'12px 16px',borderRadius:'10px',border:`1px solid ${T.inputBorder}`,background:T.inputBg,color:T.inputText,fontSize:'14px',boxSizing:'border-box',outline:'none',width:'100%'};
  const selectStyle = {...inputStyle,cursor:'pointer',minWidth:'148px'};
  const btnP = {padding:'12px 24px',borderRadius:'10px',border:'none',cursor:'pointer',fontWeight:'600',fontSize:'14px',background:T.tabActive,color:'#fff',boxShadow:'0 3px 12px rgba(20,184,166,0.3)'};
  const btnS = {padding:'12px 24px',borderRadius:'10px',border:`1px solid ${T.border}`,cursor:'pointer',fontWeight:'600',fontSize:'14px',background:'rgba(255,255,255,0.06)',color:T.textSecondary};
  const labelStyle = {display:'block',marginBottom:'8px',fontSize:'11px',color:T.textMuted,fontWeight:'600',textTransform:'uppercase',letterSpacing:'0.8px'};

  // Auth effect
  useEffect(()=>{
    if(!supabase){setAuthLoading(false);return;}
    supabase.auth.getSession().then(({data:{session}})=>{
      if(session?.user){setUser(session.user);checkUserRole(session.user.email);}
      else setAuthLoading(false);
    });
    const{data:{subscription}}=supabase.auth.onAuthStateChange((event,session)=>{
      if(session?.user){setUser(session.user);checkUserRole(session.user.email);}
      else{setUser(null);setUserRole(null);setUserName('');setAuthLoading(false);}
    });
    return()=>subscription.unsubscribe();
  },[]);
  const signInWithGoogle=async()=>{if(!supabase)return;await supabase.auth.signInWithOAuth({provider:'google',options:{redirectTo:window.location.origin}});};
  const signOut=async()=>{if(!supabase)return;await supabase.auth.signOut();setUser(null);setUserRole(null);setUserName('');};
  const checkUserRole=async(email)=>{try{const r=await fetch(`/api/auth/role?email=${encodeURIComponent(email)}`);const d=await r.json();setUserRole(d.role||'agent');setUserName(d.name||email.split('@')[0]);}catch(e){setUserRole('agent');setUserName(email.split('@')[0]);}setAuthLoading(false);};

  useEffect(()=>{const p=new URLSearchParams(window.location.search);const t=p.get('ticket_id');if(t){setTicketData({id:t});fetchTicketFromGorgias(t);fetchPastEvaluations(t);}else setIsLoading(false);loadAllEvaluations();loadQueue();loadCoachingSessions();},[]);
  useEffect(()=>{if(user&&userRole)loadDisputes();},[user,userRole]);
  useEffect(()=>{if(userRole==='agent')setActiveTab('history');},[userRole]);
  useEffect(()=>{setIsEscalationAgent(escalationAgents.some(ea=>agentName.toLowerCase().includes(ea.toLowerCase())));},[agentName]);

  const fetchPastEvaluations=async(ticketId)=>{if(!supabase)return;try{const{data}=await supabase.from('evaluations').select('*').eq('ticket_id',ticketId.toString()).order('timestamp',{ascending:false}).limit(5000);if(data&&data.length>0)setPastEvaluations(data.map(r=>({id:r.id,ticketId:r.ticket_id,agentName:r.agent_name,evaluatorName:r.evaluator_name,date:r.date,timestamp:r.timestamp,zeroToleranceViolation:r.zero_tolerance_violation,scores:r.scores,finalScore:parseFloat(r.final_score),grade:r.grade,comments:r.comments,aiReasoning:r.ai_reasoning,suggestedResponse:r.scores?.suggestedResponse||'',autoGraded:r.auto_graded})));}catch(e){console.error('Failed to load past evaluations:',e);}};

  const fetchTicketFromGorgias=async(ticketId)=>{setIsLoading(true);try{const r=await fetch(`/api/ticket?ticket_id=${ticketId}`);const d=await r.json();if(!d.error&&d.messages?.length>0){setTicketMessages(d.messages);setTicketData(prev=>({...prev,...d.ticket,conversationText:d.conversationText}));if(d.agents?.length>0){setAgents(d.agents);setAgentName(d.agents[0]);}}}catch(e){console.error(e);}setIsLoading(false);};
  const loadAllEvaluations=async()=>{if(!supabase)return;let allData=[];let offset=0;const limit=1000;let iterations=0;while(iterations<10){iterations++;const{data,error}=await supabase.from('evaluations').select('*').order('timestamp',{ascending:false}).range(offset,offset+limit-1);if(error){console.error('Fetch error:',error);break;}if(!data||data.length===0){break;}allData=allData.concat(data);offset+=data.length;if(data.length<limit){break;}}if(allData.length>0)setAllEvaluations(allData.map(r=>({id:r.id,ticketId:r.ticket_id,agentName:r.agent_name,ticketLink:r.ticket_link,evaluatorName:r.evaluator_name,isEscalationAgent:r.is_escalation_agent,date:r.date,timestamp:r.timestamp,zeroToleranceViolation:r.zero_tolerance_violation,scores:r.scores,finalScore:parseFloat(r.final_score),grade:r.grade,comments:r.comments,aiReasoning:r.ai_reasoning,suggestedResponse:r.scores?.suggestedResponse||'',detectedBuzzwords:r.detected_buzzwords||[],autoGraded:r.auto_graded})));};
  const loadQueue=async()=>{if(!supabase)return;const{data}=await supabase.from('grading_queue').select('*').order('created_at',{ascending:false}).limit(500);if(data)setQueueItems(data);};
  const loadCoachingSessions=async()=>{if(!supabase)return;try{const{data}=await supabase.from('coaching_sessions').select('*').order('created_at',{ascending:false});if(data)setCoachingSessions(data);}catch(e){console.error('coaching_sessions table may not exist yet:',e);}};
  const saveCoachingDone=async(agentName)=>{if(!supabase||!coachingCoach)return;setCoachingSaving(true);try{const{error}=await supabase.from('coaching_sessions').insert([{agent_name:agentName,coached_by:coachingCoach,notes:coachingNotes||'',created_at:new Date().toISOString()}]);if(error)throw error;setShowCoachingModal(false);setCoachingCoach('');setCoachingNotes('');await loadCoachingSessions();}catch(e){alert('Failed to save: '+e.message);}setCoachingSaving(false);};
  const getLastCoaching=(agentName)=>{return coachingSessions.find(s=>s.agent_name===agentName);};
  // Dispute functions
  const loadDisputes=async()=>{if(!supabase)return;try{let q=supabase.from('disputes').select('*').order('created_at',{ascending:false});if(userRole==='agent'&&user?.email)q=q.eq('agent_email',user.email);const{data}=await q;if(data)setDisputes(data);}catch(e){console.error('Failed to load disputes:',e);}};
  const submitDispute=async(ev)=>{if(!supabase||!disputeReason.trim())return;setDisputeSaving(true);try{const{error}=await supabase.from('disputes').insert([{evaluation_id:ev.id,ticket_id:ev.ticketId,agent_email:user.email,agent_name:userName,reason:disputeReason.trim(),status:'pending',original_scores:ev.scores,original_final_score:ev.finalScore,original_grade:ev.grade,created_at:new Date().toISOString()}]);if(error)throw error;setShowDisputeModal(false);setDisputeReason('');setDisputeEvaluation(null);await loadDisputes();}catch(e){alert('Failed to submit dispute: '+e.message);}setDisputeSaving(false);};
  const cancelDispute=async(disputeId)=>{if(!supabase)return;if(!confirm('Cancel this dispute?'))return;try{const{error}=await supabase.from('disputes').delete().eq('id',disputeId);if(error)throw error;await loadDisputes();}catch(e){alert('Failed to cancel dispute: '+e.message);}};
  const resolveDispute=async(dispute,decision)=>{if(!supabase)return;try{const updatedScores=disputeScores||dispute.original_scores;const newFinalScore=calcScore(updatedScores.softSkills||{})*0.2+calcScore(updatedScores.issueUnderstanding||{})*0.3+calcScore(updatedScores.productProcess||{})*0.3+calcScore(updatedScores.toolsUtilization||{})*0.2;const newGrade=gr(newFinalScore);const upd={status:decision,reviewer_email:user.email,reviewer_name:userName,reviewer_notes:disputeReviewNotes,resolved_at:new Date().toISOString(),updated_scores:decision==='accepted'?updatedScores:null,updated_final_score:decision==='accepted'?newFinalScore:null,updated_grade:decision==='accepted'?newGrade:null};const{error}=await supabase.from('disputes').update(upd).eq('id',dispute.id);if(error)throw error;if(decision==='accepted'){await supabase.from('evaluations').update({scores:{...updatedScores,disputed:true,suggestedResponse:dispute.original_scores?.suggestedResponse||''},final_score:newFinalScore,grade:newGrade,ai_reasoning:(dispute.reviewer_notes?'[DISPUTE ACCEPTED] '+dispute.reviewer_notes:'')}).eq('id',dispute.evaluation_id);}setSelectedDispute(null);setDisputeReviewNotes('');setDisputeScores(null);await loadDisputes();await loadAllEvaluations();}catch(e){alert('Failed to resolve dispute: '+e.message);}};
  const buildConversationText=()=>{if(ticketData?.conversationText)return ticketData.conversationText;return ticketMessages.map(m=>{const s=m.sender?.type==='customer'?'Customer':(m.sender?.name||'Agent');const b=m.body_text||m.stripped_text||m.body_html?.replace(/<[^>]*>/g,'')||'';return`${s}: ${b}`;}).join('\n\n');};

  const analyzeTicket=async()=>{
    const ct=buildConversationText();if(!ct.trim()){alert('No ticket conversation found.');return;}
    setIsAnalyzing(true);setAnalysisComplete(false);const fb=buzzwords.filter(b=>ct.toLowerCase().includes(b));setDetectedBuzzwords(fb);
    const prompt=`You are a QA analyst. ZERO TOLERANCE: legal/lawyer/attorney/lawsuit/sue/court/chargeback/dispute charge/consumer affairs/FTC/BBB/attorney general. ESCALATION TEAM: ${escalationAgents.join(', ')}. TICKET:\n${ct}\nBuzzwords: ${fb.join(', ')||'None'}\nRespond ONLY JSON:{"ticketId":"${ticketData?.id}","agents":[{"agentName":"Name","isEscalationAgent":false,"zeroToleranceViolation":false,"violationNotes":"","scores":{"softSkills":{"tone":{"score":1-5,"explanation":""},"empathy":{"score":1-5,"explanation":""},"professionalism":{"score":1-5,"explanation":""},"clarity":{"score":1-5,"explanation":""}},"issueUnderstanding":{"correctIdentification":{"score":1-5,"explanation":""},"rootCauseAnalysis":{"score":1-5,"explanation":""},"customerContext":{"score":1-5,"explanation":""},"escalationRecognition":{"score":1-5,"explanation":""}},"productProcess":{"policyAccuracy":{"score":1-5,"explanation":""},"sopAdherence":{"score":1-5,"explanation":""},"solutionCorrectness":{"score":1-5,"explanation":""},"escalationProcess":{"score":1-5,"explanation":""}},"toolsUtilization":{"gorgiasUsage":{"score":1-5,"explanation":""},"internalNotes":{"score":1-5,"explanation":""},"shopifyUsage":{"score":1-5,"explanation":""}}},"overallAnalysis":"","suggestedFeedback":"","suggestedResponse":"write the ideal customer-facing reply the agent should have sent"}]}`;
    try{const r=await fetch('/api/analyze',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({prompt})});const d=await r.json();
    if(d.agents?.length>0){const evals=d.agents.map(a=>({agentName:a.agentName,isEscalationAgent:a.isEscalationAgent||escalationAgents.some(ea=>a.agentName?.toLowerCase().includes(ea.toLowerCase())),zeroToleranceViolation:a.zeroToleranceViolation||false,violationNotes:a.violationNotes||'',
      softSkills:{tone:a.scores?.softSkills?.tone?.score||3,empathy:a.scores?.softSkills?.empathy?.score||3,professionalism:a.scores?.softSkills?.professionalism?.score||3,clarity:a.scores?.softSkills?.clarity?.score||3},
      softSkillsExp:{tone:a.scores?.softSkills?.tone?.explanation||'',empathy:a.scores?.softSkills?.empathy?.explanation||'',professionalism:a.scores?.softSkills?.professionalism?.explanation||'',clarity:a.scores?.softSkills?.clarity?.explanation||''},
      issueUnderstanding:{correctIdentification:a.scores?.issueUnderstanding?.correctIdentification?.score||3,rootCauseAnalysis:a.scores?.issueUnderstanding?.rootCauseAnalysis?.score||3,customerContext:a.scores?.issueUnderstanding?.customerContext?.score||3,escalationRecognition:a.scores?.issueUnderstanding?.escalationRecognition?.score||3},
      issueUnderstandingExp:{correctIdentification:a.scores?.issueUnderstanding?.correctIdentification?.explanation||'',rootCauseAnalysis:a.scores?.issueUnderstanding?.rootCauseAnalysis?.explanation||'',customerContext:a.scores?.issueUnderstanding?.customerContext?.explanation||'',escalationRecognition:a.scores?.issueUnderstanding?.escalationRecognition?.explanation||''},
      productProcess:{policyAccuracy:a.scores?.productProcess?.policyAccuracy?.score||3,sopAdherence:a.scores?.productProcess?.sopAdherence?.score||3,solutionCorrectness:a.scores?.productProcess?.solutionCorrectness?.score||3,escalationProcess:a.scores?.productProcess?.escalationProcess?.score||3},
      productProcessExp:{policyAccuracy:a.scores?.productProcess?.policyAccuracy?.explanation||'',sopAdherence:a.scores?.productProcess?.sopAdherence?.explanation||'',solutionCorrectness:a.scores?.productProcess?.solutionCorrectness?.explanation||'',escalationProcess:a.scores?.productProcess?.escalationProcess?.explanation||''},
      toolsUtilization:{gorgiasUsage:a.scores?.toolsUtilization?.gorgiasUsage?.score||3,internalNotes:a.scores?.toolsUtilization?.internalNotes?.score||3,shopifyUsage:a.scores?.toolsUtilization?.shopifyUsage?.score||3},
      toolsUtilizationExp:{gorgiasUsage:a.scores?.toolsUtilization?.gorgiasUsage?.explanation||'',internalNotes:a.scores?.toolsUtilization?.internalNotes?.explanation||'',shopifyUsage:a.scores?.toolsUtilization?.shopifyUsage?.explanation||''},
      aiReasoning:a.overallAnalysis||'',comments:a.suggestedFeedback||'',suggestedResponse:a.suggestedResponse||''}));setAgentEvaluations(evals);loadAgentData(0,evals);}}catch(e){alert('Analysis failed: '+e.message);}
    setAnalysisComplete(true);setIsAnalyzing(false);
  };

  const loadAgentData=(i,ev=agentEvaluations)=>{const a=ev[i];if(!a)return;setAgentName(a.agentName);setIsEscalationAgent(a.isEscalationAgent);setZeroToleranceViolation(a.zeroToleranceViolation);setViolationNotes(a.violationNotes);setSoftSkills(a.softSkills);setSoftSkillsExp(a.softSkillsExp);setIssueUnderstanding(a.issueUnderstanding);setIssueUnderstandingExp(a.issueUnderstandingExp);setProductProcess(a.productProcess);setProductProcessExp(a.productProcessExp);setToolsUtilization(a.toolsUtilization);setToolsUtilizationExp(a.toolsUtilizationExp);setAiReasoning(a.aiReasoning);setComments(a.comments);setSuggestedResponse(a.suggestedResponse||'');setCurrentAgentIndex(i);};
  const saveCurrentAgent=()=>{const u=[...agentEvaluations];u[currentAgentIndex]={agentName,isEscalationAgent,zeroToleranceViolation,violationNotes,softSkills,softSkillsExp,issueUnderstanding,issueUnderstandingExp,productProcess,productProcessExp,toolsUtilization,toolsUtilizationExp,aiReasoning,comments,suggestedResponse};setAgentEvaluations(u);return u;};
  const switchAgent=(i)=>{saveCurrentAgent();loadAgentData(i);};
  const calcScore=(s)=>(Object.values(s).reduce((a,v)=>a+v,0)/(Object.keys(s).length*5))*100;
  const finalScore=zeroToleranceViolation?0:calcScore(softSkills)*0.2+calcScore(issueUnderstanding)*0.3+calcScore(productProcess)*0.3+calcScore(toolsUtilization)*0.2;
  const sc=(s)=>s>=90?T.teal:s>=80?T.blue:s>=70?T.amber:T.danger;
  const gr=(s)=>s>=95?'A+':s>=90?'A':s>=85?'B+':s>=80?'B':s>=75?'C+':s>=70?'C':s>=60?'D':'F';

  const createInternalNote=async(ticketId,agentName,finalScore,grade,feedback,evaluator)=>{try{const r=await fetch('/api/internal-note',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({ticketId,agentName,finalScore,grade,feedback,evaluator})});return r.ok;}catch(e){return false;}};

  const saveResult=async()=>{
    if(!supabase){alert('Database not connected.');return;}if(!evaluatorName){alert('Please select an evaluator');return;}
    const updated=saveCurrentAgent();const ats=updated.length>0?updated:[{agentName,isEscalationAgent,zeroToleranceViolation,violationNotes,softSkills,softSkillsExp,issueUnderstanding,issueUnderstandingExp,productProcess,productProcessExp,toolsUtilization,toolsUtilizationExp,aiReasoning,comments,suggestedResponse}];
    setSaveStatus('saving');
    try{for(const ag of ats){const as=ag.zeroToleranceViolation?0:calcScore(ag.softSkills)*0.2+calcScore(ag.issueUnderstanding)*0.3+calcScore(ag.productProcess)*0.3+calcScore(ag.toolsUtilization)*0.2;const g=ag.zeroToleranceViolation?'F':gr(as);
    const{error}=await supabase.from('evaluations').insert([{id:`ticket-${ticketData?.id||Date.now()}-${ag.agentName||'unknown'}-${Date.now()}`,ticket_id:ticketData?.id?.toString()||'',agent_name:ag.agentName,ticket_link:`https://osmozone.gorgias.com/app/ticket/${ticketData?.id}`,evaluator_name:evaluatorName,is_escalation_agent:ag.isEscalationAgent,date:new Date().toLocaleDateString(),zero_tolerance_violation:ag.zeroToleranceViolation,violation_notes:ag.violationNotes,scores:{softSkills:{...ag.softSkills,explanations:ag.softSkillsExp,categoryScore:calcScore(ag.softSkills)},issueUnderstanding:{...ag.issueUnderstanding,explanations:ag.issueUnderstandingExp,categoryScore:calcScore(ag.issueUnderstanding)},productProcess:{...ag.productProcess,explanations:ag.productProcessExp,categoryScore:calcScore(ag.productProcess)},toolsUtilization:{...ag.toolsUtilization,explanations:ag.toolsUtilizationExp,categoryScore:calcScore(ag.toolsUtilization)},suggestedResponse:ag.suggestedResponse||''},final_score:as,grade:g,comments:ag.comments,ai_reasoning:ag.aiReasoning,detected_buzzwords:detectedBuzzwords,auto_graded:false}]);
    if(error)throw error;}
    setSaveStatus('saved');await loadAllEvaluations();if(ticketData?.id)await fetchPastEvaluations(ticketData.id);setTimeout(()=>{setSaveStatus('');resetForm();},1500);
    }catch(e){alert('Failed: '+e.message);setSaveStatus('error');setTimeout(()=>setSaveStatus(''),3000);}
  };

  const resetForm=()=>{setAnalysisComplete(false);setAgentEvaluations([]);setCurrentAgentIndex(0);setSoftSkills({tone:0,empathy:0,professionalism:0,clarity:0});setIssueUnderstanding({correctIdentification:0,rootCauseAnalysis:0,customerContext:0,escalationRecognition:0});setProductProcess({policyAccuracy:0,sopAdherence:0,solutionCorrectness:0,escalationProcess:0});setToolsUtilization({gorgiasUsage:0,internalNotes:0,shopifyUsage:0});setComments('');setSuggestedResponse('');setAiReasoning('');setZeroToleranceViolation(false);setViolationNotes('');};

  const getFilteredResults=()=>{let f=[...allEvaluations];if(userRole==='agent'&&userName){f=f.filter(r=>r.agentName?.toLowerCase()===userName.toLowerCase());}if(dateFilter==='custom'&&customStartDate&&customEndDate){const s=new Date(customStartDate);const e=new Date(customEndDate);e.setHours(23,59,59,999);f=f.filter(r=>{const d=new Date(r.timestamp);return d>=s&&d<=e;});}else if(dateFilter!=='all'){const now=new Date();const fd=new Date();if(dateFilter==='7days')fd.setDate(now.getDate()-7);else if(dateFilter==='30days')fd.setDate(now.getDate()-30);else if(dateFilter==='90days')fd.setDate(now.getDate()-90);f=f.filter(r=>new Date(r.timestamp)>=fd);}if(agentFilter!=='all')f=f.filter(r=>r.agentName===agentFilter);if(evaluatorFilter!=='all')f=f.filter(r=>r.evaluatorName===evaluatorFilter);return f;};
  const getFilteredHistory=()=>{let f=[...allEvaluations];if(userRole==='agent'&&userName){f=f.filter(r=>r.agentName?.toLowerCase()===userName.toLowerCase());}if(historyDateFilter!=='all'){const now=new Date();const fd=new Date();if(historyDateFilter==='7days')fd.setDate(now.getDate()-7);else if(historyDateFilter==='30days')fd.setDate(now.getDate()-30);else if(historyDateFilter==='90days')fd.setDate(now.getDate()-90);f=f.filter(r=>new Date(r.timestamp)>=fd);}if(historyAgentFilter!=='all')f=f.filter(r=>r.agentName===historyAgentFilter);if(historyEvaluatorFilter!=='all')f=f.filter(r=>r.evaluatorName===historyEvaluatorFilter);return f;};

  const getAnalytics=()=>{const f=getFilteredResults();if(f.length===0)return null;const total=f.length;const avg=f.reduce((a,r)=>a+r.finalScore,0)/total;const zc=f.filter(r=>r.zeroToleranceViolation).length;
    const ca={softSkills:f.reduce((a,r)=>a+(r.scores?.softSkills?.categoryScore||0),0)/total,issueUnderstanding:f.reduce((a,r)=>a+(r.scores?.issueUnderstanding?.categoryScore||0),0)/total,productProcess:f.reduce((a,r)=>a+(r.scores?.productProcess?.categoryScore||0),0)/total,toolsUtilization:f.reduce((a,r)=>a+(r.scores?.toolsUtilization?.categoryScore||0),0)/total};
    const as={};f.forEach(r=>{if(!as[r.agentName])as[r.agentName]={name:r.agentName,totalScore:0,count:0,violations:0};as[r.agentName].totalScore+=r.finalScore;as[r.agentName].count+=1;if(r.zeroToleranceViolation)as[r.agentName].violations+=1;});
    const ap=Object.values(as).map(a=>({...a,avgScore:a.totalScore/a.count,grade:gr(a.totalScore/a.count)})).sort((a,b)=>b.avgScore-a.avgScore);
    const td=[];
    for(let i=6;i>=0;i--){const d=new Date();d.setDate(d.getDate()-i);const de=f.filter(r=>new Date(r.timestamp).toLocaleDateString()===d.toLocaleDateString());const dayAvg=de.length>0?de.reduce((a,r)=>a+r.finalScore,0)/de.length:0;td.push({date:d.toLocaleDateString('en-US',{weekday:'short'}),count:de.length,avgScore:dayAvg});}
    return{totalEvaluations:total,avgScore:avg,zeroToleranceCount:zc,categoryAvg:ca,agentPerformance:ap,passingRate:(f.filter(r=>r.finalScore>=80).length/total*100),trendData:td};
  };

  const getCoachingAnalysis=()=>{let filtered=[...allEvaluations];if(coachingDateFilter!=='all'){const now=new Date();const filterDate=new Date();if(coachingDateFilter==='7days')filterDate.setDate(now.getDate()-7);else if(coachingDateFilter==='30days')filterDate.setDate(now.getDate()-30);else if(coachingDateFilter==='90days')filterDate.setDate(now.getDate()-90);filtered=filtered.filter(r=>new Date(r.timestamp)>=filterDate);}if(coachingAgentFilter!=='all')filtered=filtered.filter(r=>r.agentName===coachingAgentFilter);if(filtered.length===0)return null;const agentData={};filtered.forEach(r=>{if(!agentData[r.agentName]){agentData[r.agentName]={name:r.agentName,evaluations:[],totalScore:0,count:0,violations:0,categories:{softSkills:{scores:[],subScores:{tone:[],empathy:[],professionalism:[],clarity:[]}},issueUnderstanding:{scores:[],subScores:{correctIdentification:[],rootCauseAnalysis:[],customerContext:[],escalationRecognition:[]}},productProcess:{scores:[],subScores:{policyAccuracy:[],sopAdherence:[],solutionCorrectness:[],escalationProcess:[]}},toolsUtilization:{scores:[],subScores:{gorgiasUsage:[],internalNotes:[],shopifyUsage:[]}}},feedbacks:[]};}const a=agentData[r.agentName];a.evaluations.push(r);a.totalScore+=r.finalScore;a.count++;if(r.zeroToleranceViolation)a.violations++;if(r.scores?.softSkills?.categoryScore)a.categories.softSkills.scores.push(r.scores.softSkills.categoryScore);if(r.scores?.issueUnderstanding?.categoryScore)a.categories.issueUnderstanding.scores.push(r.scores.issueUnderstanding.categoryScore);if(r.scores?.productProcess?.categoryScore)a.categories.productProcess.scores.push(r.scores.productProcess.categoryScore);if(r.scores?.toolsUtilization?.categoryScore)a.categories.toolsUtilization.scores.push(r.scores.toolsUtilization.categoryScore);['tone','empathy','professionalism','clarity'].forEach(k=>{if(r.scores?.softSkills?.[k])a.categories.softSkills.subScores[k].push(r.scores.softSkills[k]);});['correctIdentification','rootCauseAnalysis','customerContext','escalationRecognition'].forEach(k=>{if(r.scores?.issueUnderstanding?.[k])a.categories.issueUnderstanding.subScores[k].push(r.scores.issueUnderstanding[k]);});['policyAccuracy','sopAdherence','solutionCorrectness','escalationProcess'].forEach(k=>{if(r.scores?.productProcess?.[k])a.categories.productProcess.subScores[k].push(r.scores.productProcess[k]);});['gorgiasUsage','internalNotes','shopifyUsage'].forEach(k=>{if(r.scores?.toolsUtilization?.[k])a.categories.toolsUtilization.subScores[k].push(r.scores.toolsUtilization[k]);});if(r.comments)a.feedbacks.push({date:r.date,feedback:r.comments,score:r.finalScore,ticketId:r.ticketId});});const agents=Object.values(agentData).map(a=>{const avgScore=a.totalScore/a.count;const catAvg={softSkills:a.categories.softSkills.scores.length?a.categories.softSkills.scores.reduce((x,y)=>x+y,0)/a.categories.softSkills.scores.length:0,issueUnderstanding:a.categories.issueUnderstanding.scores.length?a.categories.issueUnderstanding.scores.reduce((x,y)=>x+y,0)/a.categories.issueUnderstanding.scores.length:0,productProcess:a.categories.productProcess.scores.length?a.categories.productProcess.scores.reduce((x,y)=>x+y,0)/a.categories.productProcess.scores.length:0,toolsUtilization:a.categories.toolsUtilization.scores.length?a.categories.toolsUtilization.scores.reduce((x,y)=>x+y,0)/a.categories.toolsUtilization.scores.length:0};const subAvg={};Object.entries(a.categories).forEach(([cat,data])=>{subAvg[cat]={};Object.entries(data.subScores).forEach(([sub,vals])=>{subAvg[cat][sub]=vals.length?vals.reduce((x,y)=>x+y,0)/vals.length:0;});});const allSubs=[];Object.entries(subAvg).forEach(([cat,subs])=>{Object.entries(subs).forEach(([sub,val])=>{allSubs.push({category:cat,skill:sub,score:val});});});allSubs.sort((x,y)=>x.score-y.score);const weaknesses=allSubs.slice(0,3).filter(s=>s.score<4);const strengths=allSubs.slice(-3).reverse().filter(s=>s.score>=4);const recurringIssues=[];Object.entries(a.categories).forEach(([cat,data])=>{Object.entries(data.subScores).forEach(([sub,vals])=>{if(vals.length<2)return;const lowCount=vals.filter(v=>v<=2).length;if(lowCount>=2){recurringIssues.push({category:cat,skill:sub,lowCount,totalEvals:vals.length,pct:Math.round((lowCount/vals.length)*100),avg:vals.reduce((x,y)=>x+y,0)/vals.length});}});});recurringIssues.sort((a,b)=>b.pct-a.pct||b.lowCount-a.lowCount);let priority='low';if(avgScore<70||a.violations>0)priority='high';else if(avgScore<80||weaknesses.length>=2)priority='medium';return{...a,avgScore,grade:gr(avgScore),catAvg,subAvg,weaknesses,strengths,recurringIssues,priority,feedbacks:a.feedbacks.sort((x,y)=>new Date(y.date)-new Date(x.date)).slice(0,5)};});const priorityOrder={high:0,medium:1,low:2};agents.sort((a,b)=>priorityOrder[a.priority]-priorityOrder[b.priority]||a.avgScore-b.avgScore);const needsCoaching=agents.filter(a=>a.priority==='high'||a.priority==='medium');const topPerformers=agents.filter(a=>a.avgScore>=85).sort((a,b)=>b.avgScore-a.avgScore).slice(0,5);return{agents,needsCoaching,topPerformers,totalAgents:agents.length,totalEvaluations:filtered.length};};

  const exportHistoryCSV=()=>{const f=getFilteredHistory();const h=['Date','Ticket ID','Agent','Evaluator','Score','Grade','Auto','Suggested Response','Feedback'];const rows=f.map(x=>[x.date,x.ticketId,x.agentName,x.evaluatorName,x.finalScore.toFixed(1),x.grade,x.autoGraded?'Yes':'No',`"${(x.suggestedResponse||'').replace(/"/g,'""')}"`,`"${(x.comments||'').replace(/"/g,'""')}"`]);const csv=[h.join(','),...rows.map(r=>r.join(','))].join('\n');const blob=new Blob([csv],{type:'text/csv'});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download=`history-${new Date().toISOString().split('T')[0]}.csv`;document.body.appendChild(a);a.click();document.body.removeChild(a);};
  const exportCSV=()=>{const f=getFilteredResults();const h=['Date','Ticket ID','Agent','Evaluator','Score','Grade','Auto','Suggested Response','Feedback'];const rows=f.map(x=>[x.date,x.ticketId,x.agentName,x.evaluatorName,x.finalScore.toFixed(1),x.grade,x.autoGraded?'Yes':'No',`"${(x.suggestedResponse||'').replace(/"/g,'""')}"`,`"${(x.comments||'').replace(/"/g,'""')}"`]);const csv=[h.join(','),...rows.map(r=>r.join(','))].join('\n');const blob=new Blob([csv],{type:'text/csv'});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download=`evaluations-${new Date().toISOString().split('T')[0]}.csv`;document.body.appendChild(a);a.click();document.body.removeChild(a);};
  const openEmailModal=(ev)=>{setEvaluationToEmail(ev);setEmailTo('');setShowEmailModal(true);};
  const sendEvaluation=()=>{if(!emailTo||!evaluationToEmail)return;window.open(`mailto:${emailTo}?subject=${encodeURIComponent(`Ticket Evaluation - ${evaluationToEmail.agentName} - ${evaluationToEmail.grade}`)}&body=${encodeURIComponent(`Agent: ${evaluationToEmail.agentName}\nTicket: https://osmozone.gorgias.com/app/ticket/${evaluationToEmail.ticketId}\nScore: ${evaluationToEmail.finalScore.toFixed(1)}% | Grade: ${evaluationToEmail.grade}\n\nFeedback:\n${evaluationToEmail.comments||'No feedback'}`)}`);setShowEmailModal(false);};
  const getTimeRemaining=(p)=>{const d=new Date(p)-new Date();if(d<=0)return'Ready';return`${Math.floor(d/3600000)}h ${Math.floor((d%3600000)/60000)}m`;};
  const statusBadge=(st)=>{const s={pending:{bg:'rgba(245,158,11,0.15)',c:T.amber,l:'‚è≥ Pending'},processing:{bg:'rgba(59,130,246,0.15)',c:T.blue,l:'üîÑ Processing'},completed:{bg:'rgba(34,197,94,0.15)',c:T.green,l:'‚úÖ Completed'},failed:{bg:'rgba(239,68,68,0.15)',c:T.danger,l:'‚ùå Failed'}}[st]||{bg:'rgba(245,158,11,0.15)',c:T.amber,l:'‚è≥ Pending'};return <span style={{padding:'5px 14px',borderRadius:'20px',fontSize:'12px',fontWeight:'600',background:s.bg,color:s.c}}>{s.l}</span>;};

  const uniqueAgents=[...new Set(allEvaluations.map(r=>r.agentName))].filter(Boolean).sort((a,b)=>a.localeCompare(b));
  const uniqueEvaluators=[...new Set(allEvaluations.map(r=>r.evaluatorName))].filter(Boolean).sort((a,b)=>a.localeCompare(b));
  const analytics=getAnalytics();
  const coaching=getCoachingAnalysis();
  const pendingCount=queueItems.filter(q=>q.status==='pending').length;
  const filteredHistory=getFilteredHistory();

  // Components
  const ScoreDetail=({label,score,explanation,color})=>(<div style={{padding:'12px',background:T.cardInner,borderRadius:'10px',marginBottom:'8px'}}><div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:explanation?'8px':0}}><span style={{fontSize:'13px',color:T.textPrimary,fontWeight:'500'}}>{label}</span><div style={{display:'flex',alignItems:'center',gap:'6px'}}><div style={{display:'flex',gap:'3px'}}>{[1,2,3,4,5].map(n=>(<div key={n} style={{width:'22px',height:'22px',borderRadius:'6px',background:score>=n?color:T.ratingOff,display:'flex',alignItems:'center',justifyContent:'center',fontSize:'10px',fontWeight:'700',color:score>=n?'#fff':T.textMuted}}>{n}</div>))}</div><span style={{fontSize:'13px',fontWeight:'700',color,marginLeft:'4px'}}>{score}/5</span></div></div>{explanation&&<div style={{fontSize:'12px',color:T.textSecondary,background:'rgba(255,255,255,0.03)',padding:'10px',borderRadius:'8px',borderLeft:`3px solid ${color}`}}>{explanation}</div>}</div>);

  const CategoryDetail=({title,icon,color,scores,explanations})=>{const cs=scores?.categoryScore||0;const fl={'Soft Skills':[{k:'tone',l:'Tone'},{k:'empathy',l:'Empathy'},{k:'professionalism',l:'Professionalism'},{k:'clarity',l:'Clarity'}],'Issue Understanding':[{k:'correctIdentification',l:'Issue ID'},{k:'rootCauseAnalysis',l:'Root Cause'},{k:'customerContext',l:'Context'},{k:'escalationRecognition',l:'Escalation'}],'Product & Process':[{k:'policyAccuracy',l:'Policy'},{k:'sopAdherence',l:'SOP'},{k:'solutionCorrectness',l:'Solution'},{k:'escalationProcess',l:'Process'}],'Tools Utilization':[{k:'gorgiasUsage',l:'Gorgias'},{k:'internalNotes',l:'Notes'},{k:'shopifyUsage',l:'Shopify'}]}[title]||[];return(<div style={{...cardStyle,overflow:'hidden',marginBottom:'14px'}}><div style={{padding:'14px 18px',background:'rgba(255,255,255,0.03)',borderBottom:`1px solid ${T.border}`,display:'flex',justifyContent:'space-between',alignItems:'center'}}><div style={{display:'flex',alignItems:'center',gap:'10px'}}><span style={{fontSize:'18px'}}>{icon}</span><span style={{fontSize:'14px',fontWeight:'600',color:T.textPrimary}}>{title}</span></div><span style={{fontSize:'16px',fontWeight:'700',color}}>{cs.toFixed(0)}%</span></div><div style={{padding:'14px'}}>{fl.map(f=>(<ScoreDetail key={f.k} label={f.l} score={scores?.[f.k]||0} explanation={explanations?.[f.k]||''} color={color}/>))}</div></div>);};

  const Rating=({label,value,onChange,explanation})=>(<div style={{marginBottom:'10px',padding:'14px',background:T.cardInner,borderRadius:'12px'}}><div style={{display:'flex',justifyContent:'space-between',alignItems:'center'}}><span style={{fontSize:'14px',color:T.textPrimary,fontWeight:'500'}}>{label}</span><div style={{display:'flex',gap:'6px'}}>{[1,2,3,4,5].map(n=>(<button key={n} onClick={()=>onChange(n)} style={{width:'38px',height:'38px',borderRadius:'10px',border:'none',background:value>=n?T.ratingOn:T.ratingOff,color:value>=n?'#fff':T.textMuted,cursor:'pointer',fontSize:'14px',fontWeight:'700',boxShadow:value>=n?'0 2px 8px rgba(20,184,166,0.35)':'none'}}>{n}</button>))}</div></div>{explanation&&<div style={{fontSize:'12px',color:T.tealLight,background:'rgba(20,184,166,0.08)',padding:'10px 12px',borderRadius:'8px',marginTop:'10px',borderLeft:`3px solid ${T.teal}`}}>{explanation}</div>}</div>);

  const GradeCategory=({title,weight,scores,setScores,explanations,fields,icon,color})=>(<div style={{...cardStyle,marginBottom:'18px',overflow:'hidden'}}><div style={{padding:'16px 20px',background:'rgba(255,255,255,0.03)',borderBottom:`1px solid ${T.border}`,display:'flex',justifyContent:'space-between',alignItems:'center'}}><div style={{display:'flex',alignItems:'center',gap:'12px'}}><span style={{fontSize:'24px'}}>{icon}</span><div><span style={{fontSize:'15px',fontWeight:'600',color:T.textPrimary}}>{title}</span><span style={{fontSize:'12px',color:T.textMuted,marginLeft:'10px'}}>Weight: {weight}%</span></div></div><div style={{background:color,padding:'8px 16px',borderRadius:'10px',boxShadow:`0 2px 8px ${color}40`}}><span style={{fontSize:'16px',fontWeight:'700',color:'#fff'}}>{calcScore(scores).toFixed(0)}%</span></div></div><div style={{padding:'16px'}}>{fields.map(f=><Rating key={f.key} label={f.label} value={scores[f.key]} onChange={v=>setScores({...scores,[f.key]:v})} explanation={explanations?.[f.key]}/>)}</div></div>);

  const StatCard=({title,value,icon,color,subtitle})=>(<div style={{...cardStyle,padding:'22px',position:'relative',overflow:'hidden'}}><div style={{position:'absolute',top:'-15px',right:'-15px',width:'80px',height:'80px',background:`${color}12`,borderRadius:'50%',filter:'blur(12px)'}}></div><div style={{display:'flex',alignItems:'center',gap:'12px',marginBottom:'14px'}}><div style={{width:'44px',height:'44px',borderRadius:'12px',background:`${color}18`,display:'flex',alignItems:'center',justifyContent:'center',fontSize:'20px'}}>{icon}</div><span style={{fontSize:'12px',color:T.textSecondary,fontWeight:'600',textTransform:'uppercase',letterSpacing:'0.5px'}}>{title}</span></div><div style={{fontSize:'32px',fontWeight:'700',color,lineHeight:1}}>{value}</div>{subtitle&&<div style={{fontSize:'12px',color:T.textMuted,marginTop:'6px'}}>{subtitle}</div>}</div>);

  const ProgressBar=({value,label,color})=>(<div style={{marginBottom:'16px'}}><div style={{display:'flex',justifyContent:'space-between',marginBottom:'6px'}}><span style={{fontSize:'13px',color:T.textSecondary,fontWeight:'500'}}>{label}</span><span style={{fontSize:'13px',color,fontWeight:'700'}}>{value.toFixed(1)}%</span></div><div style={{height:'8px',background:T.ratingOff,borderRadius:'4px',overflow:'hidden'}}><div style={{height:'100%',width:`${Math.min(value,100)}%`,background:color,borderRadius:'4px'}}></div></div></div>);

  // Auth loading
  if(authLoading)return(<div style={{minHeight:'100vh',background:T.bgGradient,display:'flex',alignItems:'center',justifyContent:'center'}}><div style={{textAlign:'center'}}><div style={{...cardStyle,width:'72px',height:'72px',display:'flex',alignItems:'center',justifyContent:'center',margin:'0 auto 20px'}}><span style={{fontSize:'34px'}}>üîê</span></div><div style={{color:T.textPrimary,fontSize:'16px',fontWeight:'500'}}>Checking authentication...</div></div></div>);
  // Login screen
  if(!user)return(<div style={{minHeight:'100vh',background:T.bgGradient,display:'flex',alignItems:'center',justifyContent:'center'}}><div style={{...cardStyle,padding:'48px',textAlign:'center',maxWidth:'400px',width:'90%'}}><div style={{width:'72px',height:'72px',borderRadius:'20px',background:'rgba(20,184,166,0.15)',display:'flex',alignItems:'center',justifyContent:'center',margin:'0 auto 24px'}}><span style={{fontSize:'36px'}}>üìä</span></div><h1 style={{margin:'0 0 8px',fontSize:'24px',fontWeight:'700',color:T.textPrimary}}>QA Ticket Grader</h1><p style={{margin:'0 0 32px',fontSize:'14px',color:T.textMuted}}>Sign in with your Google account to continue</p><button onClick={signInWithGoogle} style={{...btnP,width:'100%',padding:'16px',fontSize:'15px'}}>Sign in with Google</button></div></div>);
  if(isLoading)return(<div style={{minHeight:'100vh',background:T.bgGradient,display:'flex',alignItems:'center',justifyContent:'center'}}><div style={{textAlign:'center'}}><div style={{...cardStyle,width:'72px',height:'72px',display:'flex',alignItems:'center',justifyContent:'center',margin:'0 auto 20px'}}><span style={{fontSize:'34px'}}>üìä</span></div><div style={{color:T.textPrimary,fontSize:'16px',fontWeight:'500'}}>Loading...</div></div></div>);

  return (
    <div style={{minHeight:'100vh',background:T.bgGradient}}>
      {/* Email Modal */}
      {showEmailModal&&(<div style={{position:'fixed',inset:0,background:'rgba(0,0,0,0.5)',backdropFilter:'blur(8px)',display:'flex',alignItems:'center',justifyContent:'center',zIndex:1000}}><div style={{...cardStyle,padding:'32px',width:'90%',maxWidth:'420px'}}><div style={{textAlign:'center',marginBottom:'24px'}}><div style={{width:'56px',height:'56px',borderRadius:'16px',background:'rgba(20,184,166,0.15)',display:'flex',alignItems:'center',justifyContent:'center',margin:'0 auto 14px'}}><span style={{fontSize:'26px'}}>üìß</span></div><h3 style={{margin:0,color:T.textPrimary,fontSize:'18px'}}>Send Evaluation</h3></div><input type="email" value={emailTo} onChange={e=>setEmailTo(e.target.value)} placeholder="Email address" style={inputStyle}/><div style={{display:'flex',gap:'12px',marginTop:'20px'}}><button onClick={()=>setShowEmailModal(false)} style={{...btnS,flex:1}}>Cancel</button><button onClick={sendEvaluation} disabled={!emailTo} style={{...btnP,flex:1,opacity:emailTo?1:0.5}}>Send</button></div></div></div>)}

      {/* Coaching Done Modal */}
      {showCoachingModal&&selectedCoachingAgent&&(<div style={{position:'fixed',inset:0,background:'rgba(0,0,0,0.5)',backdropFilter:'blur(8px)',display:'flex',alignItems:'center',justifyContent:'center',zIndex:1000}}><div style={{...cardStyle,padding:'32px',width:'90%',maxWidth:'420px'}}><div style={{textAlign:'center',marginBottom:'24px'}}><div style={{width:'56px',height:'56px',borderRadius:'16px',background:'rgba(34,197,94,0.15)',display:'flex',alignItems:'center',justifyContent:'center',margin:'0 auto 14px'}}><span style={{fontSize:'26px'}}>‚úÖ</span></div><h3 style={{margin:0,color:T.textPrimary,fontSize:'18px'}}>Mark Coaching Done</h3><p style={{margin:'8px 0 0',fontSize:'13px',color:T.textMuted}}>for {selectedCoachingAgent.name}</p></div><div style={{marginBottom:'16px'}}><label style={labelStyle}>Team Lead / Coach *</label><input value={coachingCoach} onChange={e=>setCoachingCoach(e.target.value)} placeholder="Your name" style={inputStyle}/></div><div style={{marginBottom:'16px'}}><label style={labelStyle}>Notes (optional)</label><textarea value={coachingNotes} onChange={e=>setCoachingNotes(e.target.value)} placeholder="Topics covered, action items..." style={{...inputStyle,height:'80px',resize:'none'}}/></div><div style={{display:'flex',gap:'12px'}}><button onClick={()=>{setShowCoachingModal(false);setCoachingCoach('');setCoachingNotes('');}} style={{...btnS,flex:1}}>Cancel</button><button onClick={()=>saveCoachingDone(selectedCoachingAgent.name)} disabled={!coachingCoach||coachingSaving} style={{...btnP,flex:1,background:T.success,opacity:(!coachingCoach||coachingSaving)?0.5:1}}>{coachingSaving?'Saving...':'Confirm'}</button></div></div></div>)}

      {/* Dispute Submission Modal */}
      {showDisputeModal&&disputeEvaluation&&(<div style={{position:'fixed',inset:0,background:'rgba(0,0,0,0.5)',backdropFilter:'blur(8px)',display:'flex',alignItems:'center',justifyContent:'center',zIndex:1000}}><div style={{...cardStyle,padding:'32px',width:'90%',maxWidth:'480px'}}><div style={{textAlign:'center',marginBottom:'24px'}}><div style={{width:'56px',height:'56px',borderRadius:'16px',background:'rgba(245,158,11,0.15)',display:'flex',alignItems:'center',justifyContent:'center',margin:'0 auto 14px'}}><span style={{fontSize:'26px'}}>‚öñÔ∏è</span></div><h3 style={{margin:0,color:T.textPrimary,fontSize:'18px'}}>Dispute Evaluation</h3><p style={{margin:'8px 0 0',fontSize:'13px',color:T.textMuted}}>Ticket #{disputeEvaluation.ticketId} ‚Ä¢ {disputeEvaluation.agentName}</p></div><div style={{padding:'16px',background:T.cardInner,borderRadius:'12px',marginBottom:'20px'}}><div style={{display:'flex',justifyContent:'space-between',alignItems:'center'}}><span style={{fontSize:'13px',color:T.textSecondary}}>Current Score</span><div style={{display:'flex',alignItems:'center',gap:'10px'}}><span style={{fontSize:'20px',fontWeight:'700',color:sc(disputeEvaluation.finalScore)}}>{disputeEvaluation.finalScore.toFixed(1)}%</span><span style={{padding:'4px 12px',borderRadius:'8px',fontSize:'14px',fontWeight:'700',background:`${sc(disputeEvaluation.finalScore)}18`,color:sc(disputeEvaluation.finalScore)}}>{disputeEvaluation.grade}</span></div></div></div><div style={{marginBottom:'20px'}}><label style={labelStyle}>Reason for Dispute *</label><textarea value={disputeReason} onChange={e=>setDisputeReason(e.target.value)} placeholder="Explain why you're disputing this evaluation..." style={{...inputStyle,height:'120px',resize:'none'}}/></div><div style={{display:'flex',gap:'12px'}}><button onClick={()=>{setShowDisputeModal(false);setDisputeReason('');setDisputeEvaluation(null);}} style={{...btnS,flex:1}}>Cancel</button><button onClick={()=>submitDispute(disputeEvaluation)} disabled={!disputeReason.trim()||disputeSaving} style={{...btnP,flex:1,background:T.amber,opacity:(!disputeReason.trim()||disputeSaving)?0.5:1}}>{disputeSaving?'Submitting...':'Submit Dispute'}</button></div></div></div>)}

      {/* Dispute Review Modal */}
      {selectedDispute&&(()=>{const ds=disputeScores||selectedDispute.original_scores||{};const getScore=(cat,key)=>ds[cat]?.[key]||0;const setScore=(cat,key,val)=>{const updated={...ds,[cat]:{...ds[cat],[key]:val,categoryScore:calcScore({...ds[cat],[key]:val})}};setDisputeScores(updated);};const newFinal=calcScore(ds.softSkills||{})*0.2+calcScore(ds.issueUnderstanding||{})*0.3+calcScore(ds.productProcess||{})*0.3+calcScore(ds.toolsUtilization||{})*0.2;return(<div style={{position:'fixed',inset:0,background:'rgba(0,0,0,0.5)',backdropFilter:'blur(8px)',display:'flex',alignItems:'center',justifyContent:'center',zIndex:1000,padding:'20px'}}><div style={{...cardStyle,width:'100%',maxWidth:'700px',maxHeight:'90vh',overflow:'auto'}}><div style={{padding:'24px',borderBottom:`1px solid ${T.border}`,position:'sticky',top:0,background:T.cardFlat,zIndex:10}}><div style={{display:'flex',justifyContent:'space-between',alignItems:'flex-start'}}><div><h2 style={{margin:0,fontSize:'20px',color:T.textPrimary,fontWeight:'600'}}>Review Dispute</h2><p style={{margin:'6px 0 0',fontSize:'13px',color:T.textSecondary}}>{selectedDispute.agent_name} ‚Ä¢ Ticket #{selectedDispute.ticket_id}</p></div><button onClick={()=>{setSelectedDispute(null);setDisputeReviewNotes('');setDisputeScores(null);}} style={{padding:'8px',borderRadius:'8px',border:`1px solid ${T.border}`,background:T.cardInner,color:T.textSecondary,cursor:'pointer',fontSize:'16px'}}>‚úï</button></div></div><div style={{padding:'24px'}}><div style={{display:'flex',gap:'16px',marginBottom:'20px'}}><div style={{flex:1,padding:'16px',background:T.cardInner,borderRadius:'12px'}}><div style={{fontSize:'11px',color:T.textMuted,fontWeight:'600',textTransform:'uppercase',marginBottom:'8px'}}>Original Score</div><div style={{display:'flex',alignItems:'center',gap:'10px'}}><span style={{fontSize:'24px',fontWeight:'700',color:sc(selectedDispute.original_final_score||0)}}>{(selectedDispute.original_final_score||0).toFixed(1)}%</span><span style={{padding:'4px 10px',borderRadius:'8px',fontSize:'14px',fontWeight:'700',background:`${sc(selectedDispute.original_final_score||0)}18`,color:sc(selectedDispute.original_final_score||0)}}>{selectedDispute.original_grade||'‚Äî'}</span></div></div><div style={{flex:1,padding:'16px',background:'rgba(20,184,166,0.06)',borderRadius:'12px',borderLeft:`3px solid ${T.teal}`}}><div style={{fontSize:'11px',color:T.teal,fontWeight:'600',textTransform:'uppercase',marginBottom:'8px'}}>Updated Score</div><div style={{display:'flex',alignItems:'center',gap:'10px'}}><span style={{fontSize:'24px',fontWeight:'700',color:sc(newFinal)}}>{newFinal.toFixed(1)}%</span><span style={{padding:'4px 10px',borderRadius:'8px',fontSize:'14px',fontWeight:'700',background:`${sc(newFinal)}18`,color:sc(newFinal)}}>{gr(newFinal)}</span></div></div></div><div style={{padding:'16px',background:'rgba(245,158,11,0.06)',borderRadius:'12px',marginBottom:'20px',borderLeft:`3px solid ${T.amber}`}}><div style={{fontSize:'11px',color:T.amber,fontWeight:'600',textTransform:'uppercase',marginBottom:'8px',letterSpacing:'0.5px'}}>Agent's Reason</div><div style={{fontSize:'14px',color:T.textPrimary,lineHeight:'1.7'}}>{selectedDispute.reason}</div></div><button onClick={()=>{const ev=allEvaluations.find(e=>e.id===selectedDispute.evaluation_id);if(ev)setSelectedEvaluation(ev);}} style={{...btnS,width:'100%',marginBottom:'20px'}}>üîç View Full Evaluation Details</button>{[{title:'Soft Skills',cat:'softSkills',color:'#ec4899',icon:'üí¨',fields:[{k:'tone',l:'Tone'},{k:'empathy',l:'Empathy'},{k:'professionalism',l:'Professionalism'},{k:'clarity',l:'Clarity'}]},{title:'Issue Understanding',cat:'issueUnderstanding',color:T.teal,icon:'üîç',fields:[{k:'correctIdentification',l:'Issue ID'},{k:'rootCauseAnalysis',l:'Root Cause'},{k:'customerContext',l:'Context'},{k:'escalationRecognition',l:'Escalation'}]},{title:'Product & Process',cat:'productProcess',color:T.amber,icon:'üìã',fields:[{k:'policyAccuracy',l:'Policy'},{k:'sopAdherence',l:'SOP'},{k:'solutionCorrectness',l:'Solution'},{k:'escalationProcess',l:'Process'}]},{title:'Tools Utilization',cat:'toolsUtilization',color:T.blue,icon:'üõ†Ô∏è',fields:[{k:'gorgiasUsage',l:'Gorgias'},{k:'internalNotes',l:'Notes'},{k:'shopifyUsage',l:'Shopify'}]}].map(section=>(<div key={section.cat} style={{padding:'16px',background:T.cardInner,borderRadius:'12px',marginBottom:'12px'}}><div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:'12px'}}><span style={{fontSize:'13px',fontWeight:'600',color:T.textPrimary}}>{section.icon} {section.title}</span><span style={{fontSize:'14px',fontWeight:'700',color:section.color}}>{calcScore(ds[section.cat]||{}).toFixed(0)}%</span></div>{section.fields.map(f=>(<div key={f.k} style={{display:'flex',justifyContent:'space-between',alignItems:'center',padding:'8px 0',borderBottom:`1px solid ${T.borderLight}`}}><span style={{fontSize:'13px',color:T.textSecondary}}>{f.l}</span><div style={{display:'flex',gap:'4px'}}>{[1,2,3,4,5].map(n=>(<button key={n} onClick={()=>setScore(section.cat,f.k,n)} style={{width:'32px',height:'32px',borderRadius:'8px',border:'none',background:getScore(section.cat,f.k)>=n?section.color:T.ratingOff,color:getScore(section.cat,f.k)>=n?'#fff':T.textMuted,cursor:'pointer',fontSize:'12px',fontWeight:'700'}}>{n}</button>))}</div></div>))}</div>))}<div style={{marginBottom:'20px'}}><label style={labelStyle}>Reviewer Notes *</label><textarea value={disputeReviewNotes} onChange={e=>setDisputeReviewNotes(e.target.value)} placeholder="Your assessment of this dispute..." style={{...inputStyle,height:'100px',resize:'none'}}/></div><div style={{display:'flex',gap:'12px'}}><button onClick={()=>resolveDispute(selectedDispute,'rejected')} disabled={!disputeReviewNotes.trim()} style={{...btnS,flex:1,color:T.danger,borderColor:'rgba(239,68,68,0.3)',opacity:disputeReviewNotes.trim()?1:0.5}}>‚ùå Reject</button><button onClick={()=>resolveDispute(selectedDispute,'accepted')} disabled={!disputeReviewNotes.trim()} style={{...btnP,flex:1,background:T.success,opacity:disputeReviewNotes.trim()?1:0.5}}>‚úÖ Accept & Update Scores</button></div></div></div></div>);})()}

      {/* Detail Modal */}
      {selectedEvaluation&&(<div style={{position:'fixed',inset:0,background:'rgba(0,0,0,0.5)',backdropFilter:'blur(8px)',display:'flex',alignItems:'center',justifyContent:'center',zIndex:1000,padding:'20px'}}><div style={{...cardStyle,width:'100%',maxWidth:'820px',maxHeight:'90vh',overflow:'auto'}}><div style={{padding:'24px',borderBottom:`1px solid ${T.border}`,position:'sticky',top:0,background:T.cardFlat,zIndex:10}}><div style={{display:'flex',justifyContent:'space-between',alignItems:'flex-start'}}><div><h2 style={{margin:0,fontSize:'20px',color:T.textPrimary,fontWeight:'600'}}>{selectedEvaluation.agentName}</h2><p style={{margin:'6px 0 0',fontSize:'13px',color:T.textSecondary}}>by {selectedEvaluation.evaluatorName} ‚Ä¢ {selectedEvaluation.date}{selectedEvaluation.autoGraded&&<span style={{marginLeft:'10px',background:'rgba(245,158,11,0.15)',color:T.amber,padding:'3px 10px',borderRadius:'8px',fontSize:'11px',fontWeight:'600'}}>AUTO</span>}</p><a href={`https://osmozone.gorgias.com/app/ticket/${selectedEvaluation.ticketId}`} target="_blank" rel="noopener noreferrer" style={{display:'inline-flex',alignItems:'center',gap:'6px',marginTop:'10px',padding:'7px 14px',background:T.cardInner,color:T.tealLight,borderRadius:'8px',textDecoration:'none',fontSize:'13px',fontWeight:'600',border:`1px solid ${T.border}`}}>üîó Ticket #{selectedEvaluation.ticketId}</a></div><div style={{display:'flex',alignItems:'center',gap:'14px'}}><div style={{fontSize:'32px',fontWeight:'700',color:sc(selectedEvaluation.finalScore)}}>{selectedEvaluation.finalScore.toFixed(1)}%</div><div style={{background:`${sc(selectedEvaluation.finalScore)}18`,border:`2px solid ${sc(selectedEvaluation.finalScore)}`,color:sc(selectedEvaluation.finalScore),padding:'12px 20px',borderRadius:'14px',fontWeight:'700',fontSize:'26px'}}>{selectedEvaluation.grade}</div><button onClick={()=>setSelectedEvaluation(null)} style={{padding:'8px',borderRadius:'8px',border:`1px solid ${T.border}`,background:T.cardInner,color:T.textSecondary,cursor:'pointer',fontSize:'16px'}}>‚úï</button></div></div></div><div style={{padding:'24px'}}>{selectedEvaluation.suggestedResponse&&(<div style={{padding:'18px',background:'rgba(34,197,94,0.06)',borderRadius:'14px',marginBottom:'20px',borderLeft:`3px solid ${T.green}`}}><div style={{fontSize:'11px',color:T.green,fontWeight:'600',textTransform:'uppercase',marginBottom:'8px',letterSpacing:'0.5px'}}>Suggested Response</div><div style={{fontSize:'14px',color:T.textPrimary,lineHeight:'1.7'}}>{selectedEvaluation.suggestedResponse}</div></div>)}{selectedEvaluation.comments&&(<div style={{padding:'18px',background:T.cardInner,borderRadius:'14px',marginBottom:'20px',borderLeft:`3px solid ${T.teal}`}}><div style={{fontSize:'11px',color:T.textMuted,fontWeight:'600',textTransform:'uppercase',marginBottom:'8px',letterSpacing:'0.5px'}}>Feedback</div><div style={{fontSize:'14px',color:T.textPrimary,lineHeight:'1.7'}}>{selectedEvaluation.comments}</div></div>)}{selectedEvaluation.aiReasoning&&(<div style={{padding:'18px',background:'rgba(59,130,246,0.06)',borderRadius:'14px',marginBottom:'20px',borderLeft:`3px solid ${T.blue}`}}><div style={{fontSize:'11px',color:T.blue,fontWeight:'600',textTransform:'uppercase',marginBottom:'8px',letterSpacing:'0.5px'}}>AI Analysis</div><div style={{fontSize:'13px',color:T.textSecondary,lineHeight:'1.7'}}>{selectedEvaluation.aiReasoning}</div></div>)}<div style={{display:'grid',gridTemplateColumns:'repeat(auto-fit,minmax(340px,1fr))',gap:'14px'}}><CategoryDetail title="Soft Skills" icon="üí¨" color="#ec4899" scores={selectedEvaluation.scores?.softSkills} explanations={selectedEvaluation.scores?.softSkills?.explanations}/><CategoryDetail title="Issue Understanding" icon="üîç" color={T.teal} scores={selectedEvaluation.scores?.issueUnderstanding} explanations={selectedEvaluation.scores?.issueUnderstanding?.explanations}/><CategoryDetail title="Product & Process" icon="üìã" color={T.amber} scores={selectedEvaluation.scores?.productProcess} explanations={selectedEvaluation.scores?.productProcess?.explanations}/><CategoryDetail title="Tools Utilization" icon="üõ†Ô∏è" color={T.blue} scores={selectedEvaluation.scores?.toolsUtilization} explanations={selectedEvaluation.scores?.toolsUtilization?.explanations}/></div><div style={{display:'flex',gap:'12px',marginTop:'22px'}}><button onClick={()=>openEmailModal(selectedEvaluation)} style={{...btnS,flex:1}}>üìß Send</button><button onClick={()=>setSelectedEvaluation(null)} style={{...btnP,flex:1}}>Close</button></div></div></div></div>)}

      <div style={{maxWidth:'1400px',margin:'0 auto',padding:'28px'}}>
        {/* Header */}
        <div style={{marginBottom:'30px',display:'flex',alignItems:'center',justifyContent:'space-between',flexWrap:'wrap',gap:'20px'}}>
          <div style={{display:'flex',alignItems:'center',gap:'16px'}}><div style={{...cardStyle,width:'56px',height:'56px',display:'flex',alignItems:'center',justifyContent:'center'}}><span style={{fontSize:'28px'}}>üìä</span></div><div><h1 style={{margin:0,fontSize:'26px',fontWeight:'700',color:T.textPrimary}}>QA Ticket Grader</h1><div style={{display:'flex',alignItems:'center',gap:'8px',marginTop:'4px'}}><span style={{fontSize:'13px',color:T.textSecondary}}>{userName}</span><span style={{padding:'2px 8px',borderRadius:'6px',fontSize:'10px',fontWeight:'700',background:userRole==='team_lead'?'rgba(20,184,166,0.15)':'rgba(59,130,246,0.15)',color:userRole==='team_lead'?T.teal:T.blue}}>{userRole==='team_lead'?'Team Lead':'Agent'}</span>{ticketData?.id&&<span style={{fontSize:'13px',color:T.textMuted}}>‚Ä¢ Ticket #{ticketData.id}</span>}</div></div></div>
          <div style={{display:'flex',gap:'8px',flexWrap:'wrap'}}>
            {(userRole==='team_lead'?[{id:'grade',label:'Grade',icon:'üéØ'},{id:'history',label:'History',count:filteredHistory.length,icon:'üìã'},{id:'queue',label:'Queue',count:pendingCount,icon:'‚è≥'},{id:'analytics',label:'Analytics',icon:'üìà'},{id:'coaching',label:'Coaching',icon:'üéì'},{id:'disputes',label:'Disputes',count:disputes.filter(d=>d.status==='pending').length,icon:'‚öñÔ∏è'}]:[{id:'history',label:'History',count:filteredHistory.length,icon:'üìã'},{id:'analytics',label:'My Stats',icon:'üìà'}]).map(tab=>(<button key={tab.id} onClick={()=>{setActiveTab(tab.id);if(tab.id==='queue')loadQueue();if(tab.id==='disputes')loadDisputes();}} style={{padding:'11px 22px',borderRadius:'12px',border:activeTab===tab.id?'none':`1px solid ${T.border}`,background:activeTab===tab.id?T.tabActive:T.tabInactive,color:activeTab===tab.id?'#fff':T.textSecondary,cursor:'pointer',fontWeight:'600',fontSize:'13px',display:'flex',alignItems:'center',gap:'8px',boxShadow:activeTab===tab.id?'0 4px 14px rgba(20,184,166,0.35)':'none',transition:'all 0.2s'}}>{tab.icon} {tab.label}{tab.count!==undefined&&<span style={{background:activeTab===tab.id?'rgba(255,255,255,0.2)':'rgba(255,255,255,0.06)',padding:'2px 9px',borderRadius:'8px',fontSize:'11px',fontWeight:'700'}}>{tab.count}</span>}</button>))}
            <button onClick={signOut} style={{padding:'11px 18px',borderRadius:'12px',border:`1px solid ${T.border}`,background:'rgba(255,255,255,0.04)',color:T.textMuted,cursor:'pointer',fontWeight:'600',fontSize:'13px',transition:'all 0.2s'}}>Sign Out</button>
          </div>
        </div>

        {/* QUEUE */}
        {activeTab==='queue'&&(<div><div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:'22px'}}><div><h2 style={{margin:0,fontSize:'20px',color:T.textPrimary,fontWeight:'600'}}>Auto-Grade Queue</h2><p style={{margin:'4px 0 0',fontSize:'13px',color:T.textMuted}}>Tickets waiting for evaluation</p></div><button onClick={loadQueue} style={btnS}>üîÑ Refresh</button></div>{queueItems.length===0?(<div style={{...cardStyle,textAlign:'center',padding:'70px'}}><div style={{fontSize:'56px',marginBottom:'16px',opacity:0.6}}>üì≠</div><p style={{color:T.textMuted,fontSize:'15px',margin:0}}>No tickets in queue</p></div>):(<div style={{...cardStyle,overflow:'hidden'}}><table style={{width:'100%',borderCollapse:'collapse'}}><thead><tr style={{background:'rgba(255,255,255,0.03)'}}>{['Ticket ID','Status','Queued','Process At','Time Left'].map(h=>(<th key={h} style={{padding:'14px 16px',textAlign:'left',color:T.textMuted,fontSize:'11px',fontWeight:'600',textTransform:'uppercase',letterSpacing:'0.6px'}}>{h}</th>))}</tr></thead><tbody>{queueItems.map(q=>(<tr key={q.id} style={{borderBottom:`1px solid ${T.borderLight}`}}><td style={{padding:'14px 16px'}}><a href={`https://osmozone.gorgias.com/app/ticket/${q.ticket_id}`} target="_blank" rel="noopener noreferrer" style={{color:T.tealLight,textDecoration:'none',fontWeight:'600'}}>#{q.ticket_id}</a></td><td style={{padding:'14px 16px'}}>{statusBadge(q.status)}</td><td style={{padding:'14px 16px',color:T.textSecondary,fontSize:'13px'}}>{new Date(q.created_at).toLocaleString()}</td><td style={{padding:'14px 16px',color:T.textSecondary,fontSize:'13px'}}>{new Date(q.process_at).toLocaleString()}</td><td style={{padding:'14px 16px'}}>{q.status==='pending'?<span style={{color:T.amber,fontWeight:'700'}}>{getTimeRemaining(q.process_at)}</span>:'‚Äî'}</td></tr>))}</tbody></table></div>)}</div>)}

        {/* HISTORY */}
        {activeTab==='history'&&(<div><div style={{...cardStyle,padding:'22px',marginBottom:'22px'}}><div style={{display:'flex',gap:'14px',flexWrap:'wrap',alignItems:'flex-end'}}><div><label style={labelStyle}>Date Range</label><select value={historyDateFilter} onChange={e=>setHistoryDateFilter(e.target.value)} style={selectStyle}><option value="all">All Time</option><option value="7days">Last 7 Days</option><option value="30days">Last 30 Days</option><option value="90days">Last 90 Days</option></select></div><div><label style={labelStyle}>Agent</label><select value={historyAgentFilter} onChange={e=>setHistoryAgentFilter(e.target.value)} style={selectStyle}><option value="all">All Agents</option>{uniqueAgents.map(a=><option key={a} value={a}>{a}</option>)}</select></div><div><label style={labelStyle}>Evaluator</label><select value={historyEvaluatorFilter} onChange={e=>setHistoryEvaluatorFilter(e.target.value)} style={selectStyle}><option value="all">All Evaluators</option>{uniqueEvaluators.map(e=><option key={e} value={e}>{e}</option>)}</select></div><div style={{marginLeft:'auto',display:'flex',alignItems:'center',gap:'14px'}}><span style={{fontSize:'13px',color:T.textSecondary}}>Showing <strong style={{color:T.tealLight}}>{filteredHistory.length}</strong> evaluations</span><button onClick={exportHistoryCSV} disabled={filteredHistory.length===0} style={{...btnP,padding:'9px 18px',fontSize:'13px',background:T.success,opacity:filteredHistory.length===0?0.4:1}}>üì• Export CSV</button></div></div></div>{filteredHistory.length===0?(<div style={{...cardStyle,textAlign:'center',padding:'70px'}}><div style={{fontSize:'56px',marginBottom:'16px',opacity:0.6}}>üì≠</div><p style={{color:T.textMuted,fontSize:'15px'}}>No evaluations found</p></div>):(<div style={{display:'grid',gap:'12px'}}>{filteredHistory.map(h=>(<div key={h.id} onClick={()=>setSelectedEvaluation(h)} style={{...cardStyle,padding:'20px',cursor:'pointer',transition:'all 0.2s'}}><div style={{display:'flex',justifyContent:'space-between',alignItems:'center',flexWrap:'wrap',gap:'14px'}}><div style={{display:'flex',alignItems:'center',gap:'14px'}}><div style={{width:'46px',height:'46px',borderRadius:'12px',background:`${sc(h.finalScore)}18`,display:'flex',alignItems:'center',justifyContent:'center',fontSize:'18px',fontWeight:'700',color:sc(h.finalScore)}}>{h.grade}</div><div><div style={{fontSize:'15px',fontWeight:'600',color:T.textPrimary}}>{h.agentName}</div><div style={{fontSize:'12px',color:T.textMuted,marginTop:'3px'}}>by {h.evaluatorName} ‚Ä¢ {h.date}{h.autoGraded&&<span style={{marginLeft:'8px',background:'rgba(245,158,11,0.15)',color:T.amber,padding:'2px 8px',borderRadius:'6px',fontSize:'10px',fontWeight:'600'}}>AUTO</span>}</div></div></div><div style={{display:'flex',alignItems:'center',gap:'14px'}}><div style={{display:'flex',gap:'6px'}}>{[{l:'Soft',v:h.scores?.softSkills?.categoryScore,c:'#ec4899'},{l:'Issue',v:h.scores?.issueUnderstanding?.categoryScore,c:T.teal},{l:'Process',v:h.scores?.productProcess?.categoryScore,c:T.amber},{l:'Tools',v:h.scores?.toolsUtilization?.categoryScore,c:T.blue}].map((c,i)=>(<div key={i} style={{textAlign:'center',padding:'5px 8px',background:T.cardInner,borderRadius:'8px',minWidth:'48px'}}><div style={{fontSize:'9px',color:T.textMuted}}>{c.l}</div><div style={{fontSize:'12px',fontWeight:'700',color:c.c,marginTop:'1px'}}>{c.v?.toFixed(0)||0}%</div></div>))}</div><div style={{fontSize:'22px',fontWeight:'700',color:sc(h.finalScore)}}>{h.finalScore.toFixed(1)}%</div><div style={{color:T.textMuted,fontSize:'18px'}}>‚Ä∫</div></div></div>{userRole==='agent'&&<div style={{marginTop:'10px',display:'flex',gap:'8px',alignItems:'center'}}>{(()=>{const dp=disputes.find(d=>d.evaluation_id===h.id);if(!dp)return <button onClick={(e)=>{e.stopPropagation();setDisputeEvaluation(h);setShowDisputeModal(true);}} style={{...btnS,padding:'6px 14px',fontSize:'12px',background:'rgba(245,158,11,0.08)',color:T.amber,border:'1px solid rgba(245,158,11,0.2)'}}>‚öñÔ∏è Dispute</button>;return<><span style={{padding:'6px 14px',borderRadius:'8px',fontSize:'12px',fontWeight:'600',background:dp.status==='pending'?'rgba(245,158,11,0.15)':dp.status==='accepted'?'rgba(34,197,94,0.15)':'rgba(239,68,68,0.15)',color:dp.status==='pending'?T.amber:dp.status==='accepted'?T.green:T.danger}}>{dp.status==='pending'?'‚è≥ Dispute Pending':dp.status==='accepted'?'‚úÖ Dispute Accepted':'‚ùå Dispute Rejected'}</span>{dp.status==='pending'&&<button onClick={(e)=>{e.stopPropagation();cancelDispute(dp.id);}} style={{...btnS,padding:'4px 12px',fontSize:'11px',color:T.textMuted}}>Cancel</button>}{dp.status!=='pending'&&dp.reviewer_notes&&<span style={{fontSize:'11px',color:T.textMuted,marginLeft:'4px'}}>‚Äî {dp.reviewer_notes.length>60?dp.reviewer_notes.substring(0,60)+'...':dp.reviewer_notes}</span>}</>;})()}</div>}{h.suggestedResponse&&<div style={{marginTop:'12px',padding:'10px',background:'rgba(34,197,94,0.06)',borderRadius:'8px',fontSize:'12px',color:T.textSecondary,borderLeft:`2px solid ${T.green}`}}><span style={{fontSize:'10px',color:T.green,fontWeight:'600',textTransform:'uppercase',letterSpacing:'0.3px',display:'block',marginBottom:'4px'}}>Suggested Response</span>{h.suggestedResponse.length>200?h.suggestedResponse.substring(0,200)+'...':h.suggestedResponse}</div>}{h.comments&&<div style={{marginTop:'8px',padding:'10px',background:T.cardInner,borderRadius:'8px',fontSize:'12px',color:T.textSecondary,borderLeft:`2px solid ${T.teal}`}}><span style={{fontSize:'10px',color:T.teal,fontWeight:'600',textTransform:'uppercase',letterSpacing:'0.3px',display:'block',marginBottom:'4px'}}>Feedback</span>{h.comments.length>200?h.comments.substring(0,200)+'...':h.comments}</div>}{h.aiReasoning&&<div style={{marginTop:'8px',padding:'10px',background:'rgba(59,130,246,0.06)',borderRadius:'8px',fontSize:'12px',color:T.textSecondary,borderLeft:`2px solid ${T.blue}`}}><span style={{fontSize:'10px',color:T.blue,fontWeight:'600',textTransform:'uppercase',letterSpacing:'0.3px',display:'block',marginBottom:'4px'}}>AI Analysis</span>{h.aiReasoning.length>200?h.aiReasoning.substring(0,200)+'...':h.aiReasoning}</div>}</div>))}</div>)}</div>)}

        {/* ANALYTICS */}
        {activeTab==='analytics'&&(()=>{const f=getFilteredResults();const subScoreData={};f.forEach(r=>{['tone','empathy','professionalism','clarity'].forEach(k=>{if(r.scores?.softSkills?.[k]){if(!subScoreData[k])subScoreData[k]={name:k,cat:'Soft Skills',scores:[]};subScoreData[k].scores.push(r.scores.softSkills[k]);}});['correctIdentification','rootCauseAnalysis','customerContext','escalationRecognition'].forEach(k=>{if(r.scores?.issueUnderstanding?.[k]){if(!subScoreData[k])subScoreData[k]={name:k,cat:'Issue Understanding',scores:[]};subScoreData[k].scores.push(r.scores.issueUnderstanding[k]);}});['policyAccuracy','sopAdherence','solutionCorrectness','escalationProcess'].forEach(k=>{if(r.scores?.productProcess?.[k]){if(!subScoreData[k])subScoreData[k]={name:k,cat:'Product & Process',scores:[]};subScoreData[k].scores.push(r.scores.productProcess[k]);}});['gorgiasUsage','internalNotes','shopifyUsage'].forEach(k=>{if(r.scores?.toolsUtilization?.[k]){if(!subScoreData[k])subScoreData[k]={name:k,cat:'Tools',scores:[]};subScoreData[k].scores.push(r.scores.toolsUtilization[k]);}});});const allSubs=Object.values(subScoreData).map(s=>({...s,avg:s.scores.reduce((a,b)=>a+b,0)/s.scores.length})).sort((a,b)=>a.avg-b.avg);const weaknesses=allSubs.slice(0,4).filter(s=>s.avg<4);const strengths=allSubs.slice(-4).reverse().filter(s=>s.avg>=3.5);return(<div><div style={{...cardStyle,padding:'22px',marginBottom:'24px'}}><div style={{display:'flex',gap:'14px',flexWrap:'wrap',alignItems:'flex-end'}}><div><label style={labelStyle}>Date Range</label><select value={dateFilter} onChange={e=>setDateFilter(e.target.value)} style={selectStyle}><option value="all">All Time</option><option value="7days">Last 7 Days</option><option value="30days">Last 30 Days</option><option value="90days">Last 90 Days</option><option value="custom">Custom</option></select></div>{dateFilter==='custom'&&(<><div><label style={labelStyle}>Start</label><input type="date" value={customStartDate} onChange={e=>setCustomStartDate(e.target.value)} style={inputStyle}/></div><div><label style={labelStyle}>End</label><input type="date" value={customEndDate} onChange={e=>setCustomEndDate(e.target.value)} style={inputStyle}/></div></>)}{userRole==='team_lead'&&<><div><label style={labelStyle}>Agent</label><select value={agentFilter} onChange={e=>setAgentFilter(e.target.value)} style={selectStyle}><option value="all">All Agents</option>{uniqueAgents.map(a=><option key={a} value={a}>{a}</option>)}</select></div><div><label style={labelStyle}>Evaluator</label><select value={evaluatorFilter} onChange={e=>setEvaluatorFilter(e.target.value)} style={selectStyle}><option value="all">All Evaluators</option>{uniqueEvaluators.map(e=><option key={e} value={e}>{e}</option>)}</select></div></>}<button onClick={exportCSV} style={{...btnP,marginLeft:'auto',background:T.success}}>üì• Export</button></div></div>{!analytics?(<div style={{...cardStyle,textAlign:'center',padding:'70px'}}><div style={{fontSize:'56px',marginBottom:'16px',opacity:0.6}}>üì≠</div><p style={{color:T.textMuted,fontSize:'15px'}}>No evaluation data</p></div>):(<><div style={{display:'grid',gridTemplateColumns:'repeat(auto-fit,minmax(240px,1fr))',gap:'16px',marginBottom:'24px'}}><StatCard title="Total Evaluations" value={analytics.totalEvaluations} icon="üìù" color={T.teal}/><StatCard title="Average Score" value={`${analytics.avgScore.toFixed(1)}%`} icon="‚≠ê" color={T.blue} subtitle={`Grade: ${gr(analytics.avgScore)}`}/><StatCard title="Passing Rate" value={`${analytics.passingRate.toFixed(0)}%`} icon="‚úÖ" color={T.green} subtitle="Score ‚â• 80%"/><StatCard title="Violations" value={analytics.zeroToleranceCount} icon="üö®" color={T.danger} subtitle="Zero Tolerance"/></div><div style={{display:'grid',gridTemplateColumns:'repeat(auto-fit,minmax(380px,1fr))',gap:'20px',marginBottom:'24px'}}><div style={{...cardStyle,padding:'24px'}}><h3 style={{margin:'0 0 20px',fontSize:'16px',color:T.textPrimary,fontWeight:'600'}}>üìà 7-Day Avg Score</h3><div style={{display:'flex',alignItems:'flex-end',gap:'8px',height:'160px',padding:'0 8px'}}>{analytics.trendData.map((d,i)=>{const bh=d.avgScore>0?(d.avgScore/100)*140:0;const barColor=d.avgScore>=90?T.teal:d.avgScore>=80?T.blue:d.avgScore>=70?T.amber:d.avgScore>0?T.danger:T.slate;return(<div key={i} style={{flex:1,display:'flex',flexDirection:'column',alignItems:'center'}}><div style={{fontSize:'11px',color:d.count>0?T.textPrimary:T.textMuted,marginBottom:'6px',fontWeight:'600',textAlign:'center'}}>{d.count>0?`${d.avgScore.toFixed(0)}%`:'‚Äî'}</div><div style={{width:'100%',maxWidth:'36px',background:d.count>0?`linear-gradient(180deg,${barColor} 0%,${barColor}cc 100%)`:T.ratingOff,borderRadius:'5px 5px 0 0',height:`${Math.max(bh,3)}px`,boxShadow:d.count>0?`0 2px 8px ${barColor}30`:'none'}}></div><div style={{fontSize:'10px',color:T.textMuted,marginTop:'8px',fontWeight:'500'}}>{d.date}</div><div style={{fontSize:'9px',color:T.textMuted}}>{d.count>0?`${d.count} eval${d.count>1?'s':''}`:'‚Äî'}</div></div>);})}</div></div><div style={{...cardStyle,padding:'24px'}}><h3 style={{margin:'0 0 20px',fontSize:'16px',color:T.textPrimary,fontWeight:'600'}}>üìä Category Performance</h3><ProgressBar value={analytics.categoryAvg.softSkills} color="#ec4899" label="Soft Skills (20%)"/><ProgressBar value={analytics.categoryAvg.issueUnderstanding} color={T.teal} label="Issue Understanding (30%)"/><ProgressBar value={analytics.categoryAvg.productProcess} color={T.amber} label="Product & Process (30%)"/><ProgressBar value={analytics.categoryAvg.toolsUtilization} color={T.blue} label="Tools Utilization (20%)"/></div></div><div style={{display:'grid',gridTemplateColumns:'repeat(auto-fit,minmax(380px,1fr))',gap:'20px',marginBottom:'24px'}}>{weaknesses.length>0&&<div style={{...cardStyle,padding:'24px'}}><h3 style={{margin:'0 0 16px',fontSize:'16px',color:T.danger,fontWeight:'600'}}>üéØ Areas to Improve</h3>{weaknesses.map((w,i)=>(<div key={i} style={{padding:'12px',background:'rgba(239,68,68,0.06)',borderRadius:'10px',marginBottom:'8px',borderLeft:`3px solid ${T.danger}`}}><div style={{display:'flex',justifyContent:'space-between',alignItems:'center'}}><div><div style={{fontSize:'14px',fontWeight:'600',color:T.textPrimary}}>{w.name.replace(/([A-Z])/g,' $1').trim()}</div><div style={{fontSize:'11px',color:T.textMuted,marginTop:'2px'}}>{w.cat}</div></div><div style={{display:'flex',alignItems:'center',gap:'6px'}}><div style={{display:'flex',gap:'2px'}}>{[1,2,3,4,5].map(n=>(<div key={n} style={{width:'10px',height:'10px',borderRadius:'3px',background:w.avg>=n?T.danger:T.ratingOff}}/>))}</div><span style={{fontSize:'14px',fontWeight:'700',color:T.danger}}>{w.avg.toFixed(1)}/5</span></div></div></div>))}</div>}{strengths.length>0&&<div style={{...cardStyle,padding:'24px'}}><h3 style={{margin:'0 0 16px',fontSize:'16px',color:T.green,fontWeight:'600'}}>üí™ Strengths</h3>{strengths.map((s,i)=>(<div key={i} style={{padding:'12px',background:'rgba(34,197,94,0.06)',borderRadius:'10px',marginBottom:'8px',borderLeft:`3px solid ${T.green}`}}><div style={{display:'flex',justifyContent:'space-between',alignItems:'center'}}><div><div style={{fontSize:'14px',fontWeight:'600',color:T.textPrimary}}>{s.name.replace(/([A-Z])/g,' $1').trim()}</div><div style={{fontSize:'11px',color:T.textMuted,marginTop:'2px'}}>{s.cat}</div></div><div style={{display:'flex',alignItems:'center',gap:'6px'}}><div style={{display:'flex',gap:'2px'}}>{[1,2,3,4,5].map(n=>(<div key={n} style={{width:'10px',height:'10px',borderRadius:'3px',background:s.avg>=n?T.green:T.ratingOff}}/>))}</div><span style={{fontSize:'14px',fontWeight:'700',color:T.green}}>{s.avg.toFixed(1)}/5</span></div></div></div>))}</div>}</div>{userRole==='team_lead'&&<div style={{...cardStyle,padding:'24px'}}><h3 style={{margin:'0 0 20px',fontSize:'16px',color:T.textPrimary,fontWeight:'600'}}>üèÜ Agent Leaderboard</h3><table style={{width:'100%',borderCollapse:'collapse'}}><thead><tr style={{background:'rgba(255,255,255,0.03)'}}>{['#','Agent','Avg Score','Grade','Count','Violations'].map(h=><th key={h} style={{padding:'12px',textAlign:h==='#'||h==='Agent'?'left':'center',color:T.textMuted,fontSize:'11px',fontWeight:'600',textTransform:'uppercase',letterSpacing:'0.5px'}}>{h}</th>)}</tr></thead><tbody>{analytics.agentPerformance.map((a,i)=>(<tr key={a.name} style={{borderBottom:`1px solid ${T.borderLight}`}}><td style={{padding:'14px 12px',color:i<3?T.amber:T.textMuted,fontWeight:'700',fontSize:'15px'}}>{i===0?'ü•á':i===1?'ü•à':i===2?'ü•â':i+1}</td><td style={{padding:'14px 12px',color:T.textPrimary,fontWeight:'600'}}>{a.name}</td><td style={{padding:'14px 12px',textAlign:'center',color:sc(a.avgScore),fontWeight:'700'}}>{a.avgScore.toFixed(1)}%</td><td style={{padding:'14px 12px',textAlign:'center'}}><span style={{background:`${sc(a.avgScore)}18`,color:sc(a.avgScore),padding:'5px 14px',borderRadius:'10px',fontWeight:'700',fontSize:'13px'}}>{a.grade}</span></td><td style={{padding:'14px 12px',textAlign:'center',color:T.textSecondary}}>{a.count}</td><td style={{padding:'14px 12px',textAlign:'center',color:a.violations>0?T.danger:T.textMuted,fontWeight:a.violations>0?'700':'400'}}>{a.violations}</td></tr>))}</tbody></table></div>}</>)}</div>);})()}

        {/* COACHING */}
        {activeTab==='coaching'&&(<div>
          <div style={{...cardStyle,padding:'22px',marginBottom:'22px'}}><div style={{display:'flex',gap:'14px',flexWrap:'wrap',alignItems:'flex-end'}}><div><label style={labelStyle}>Time Period</label><select value={coachingDateFilter} onChange={e=>{setCoachingDateFilter(e.target.value);setSelectedCoachingAgent(null);}} style={selectStyle}><option value="all">All Time</option><option value="7days">Last 7 Days</option><option value="30days">Last 30 Days</option><option value="90days">Last 90 Days</option></select></div><div><label style={labelStyle}>Agent</label><select value={coachingAgentFilter} onChange={e=>{setCoachingAgentFilter(e.target.value);setSelectedCoachingAgent(null);}} style={selectStyle}><option value="all">All Agents</option>{uniqueAgents.map(a=><option key={a} value={a}>{a}</option>)}</select></div>{coaching&&<div style={{marginLeft:'auto',fontSize:'13px',color:T.textSecondary}}>Analyzing <strong style={{color:T.tealLight}}>{coaching.totalAgents}</strong> agents ‚Ä¢ <strong style={{color:T.tealLight}}>{coaching.totalEvaluations}</strong> evaluations</div>}</div></div>
          {!coaching?<div style={{...cardStyle,textAlign:'center',padding:'70px'}}><div style={{fontSize:'56px',marginBottom:'16px',opacity:0.6}}>üì≠</div><p style={{color:T.textMuted,fontSize:'15px'}}>No data for coaching analysis</p></div>:<>
            <div style={{display:'grid',gridTemplateColumns:'repeat(auto-fit,minmax(200px,1fr))',gap:'16px',marginBottom:'24px'}}><StatCard title="Needs Coaching" value={coaching.needsCoaching.length} icon="üéØ" color={T.danger} subtitle="High/Medium Priority"/><StatCard title="Top Performers" value={coaching.topPerformers.length} icon="‚≠ê" color={T.green} subtitle="Score ‚â• 85%"/><StatCard title="Total Agents" value={coaching.totalAgents} icon="üë•" color={T.teal} subtitle="With evaluations"/></div>
            <div style={{display:'grid',gridTemplateColumns:selectedCoachingAgent?'1fr 1fr':'1fr',gap:'20px'}}>
              <div>
                {coaching.needsCoaching.length>0&&<div style={{marginBottom:'24px'}}><h3 style={{margin:'0 0 16px',fontSize:'16px',color:T.danger,fontWeight:'600'}}>üö® Needs Coaching ({coaching.needsCoaching.length})</h3>{coaching.needsCoaching.map(agent=>(<div key={agent.name} onClick={()=>setSelectedCoachingAgent(agent)} style={{...cardStyle,padding:'18px',marginBottom:'12px',cursor:'pointer',border:selectedCoachingAgent?.name===agent.name?`2px solid ${T.teal}`:`1px solid ${T.border}`}}><div style={{display:'flex',justifyContent:'space-between',alignItems:'center'}}><div style={{display:'flex',alignItems:'center',gap:'14px'}}><div style={{width:'48px',height:'48px',borderRadius:'12px',background:`${sc(agent.avgScore)}18`,display:'flex',alignItems:'center',justifyContent:'center',fontSize:'18px',fontWeight:'700',color:sc(agent.avgScore)}}>{agent.grade}</div><div><div style={{fontWeight:'600',color:T.textPrimary,fontSize:'15px'}}>{agent.name}</div><div style={{fontSize:'12px',color:T.textMuted,marginTop:'2px'}}>{agent.count} evaluations{(()=>{const lc=getLastCoaching(agent.name);return lc?<span style={{marginLeft:'8px',background:'rgba(34,197,94,0.15)',color:T.green,padding:'2px 8px',borderRadius:'6px',fontSize:'10px',fontWeight:'600'}}>Coached {new Date(lc.created_at).toLocaleDateString()}</span>:null;})()}</div></div></div><div style={{textAlign:'right'}}><div style={{fontSize:'22px',fontWeight:'700',color:sc(agent.avgScore)}}>{agent.avgScore.toFixed(1)}%</div><span style={{padding:'3px 10px',borderRadius:'12px',fontSize:'10px',fontWeight:'700',background:agent.priority==='high'?'rgba(239,68,68,0.15)':'rgba(245,158,11,0.15)',color:agent.priority==='high'?T.danger:T.amber}}>{agent.priority.toUpperCase()}</span></div></div>{agent.weaknesses.length>0&&<div style={{marginTop:'10px',display:'flex',gap:'6px',flexWrap:'wrap'}}>{agent.weaknesses.map((w,i)=><span key={i} style={{padding:'4px 10px',background:'rgba(239,68,68,0.1)',borderRadius:'8px',fontSize:'11px',color:T.danger}}>{w.skill.replace(/([A-Z])/g,' $1').trim()}: {w.score.toFixed(1)}</span>)}</div>}{agent.recurringIssues?.length>0&&<div style={{marginTop:'8px',display:'flex',gap:'6px',alignItems:'center',flexWrap:'wrap'}}><span style={{padding:'4px 10px',background:'rgba(251,191,36,0.15)',borderRadius:'8px',fontSize:'11px',color:T.amber,fontWeight:'600'}}>üîÅ {agent.recurringIssues.length} recurring issue{agent.recurringIssues.length>1?'s':''}</span>{agent.recurringIssues.slice(0,2).map((ri,i)=><span key={i} style={{padding:'4px 10px',background:'rgba(251,191,36,0.08)',borderRadius:'8px',fontSize:'10px',color:T.amber}}>{ri.skill.replace(/([A-Z])/g,' $1').trim()} ({ri.pct}%)</span>)}</div>}</div>))}</div>}
                {coaching.topPerformers.length>0&&<div><h3 style={{margin:'0 0 16px',fontSize:'16px',color:T.green,fontWeight:'600'}}>‚≠ê Top Performers ({coaching.topPerformers.length})</h3>{coaching.topPerformers.map(agent=>(<div key={agent.name} onClick={()=>setSelectedCoachingAgent(agent)} style={{...cardStyle,padding:'18px',marginBottom:'12px',cursor:'pointer',border:selectedCoachingAgent?.name===agent.name?`2px solid ${T.teal}`:`1px solid ${T.border}`}}><div style={{display:'flex',justifyContent:'space-between',alignItems:'center'}}><div style={{display:'flex',alignItems:'center',gap:'14px'}}><div style={{width:'48px',height:'48px',borderRadius:'12px',background:`${sc(agent.avgScore)}18`,display:'flex',alignItems:'center',justifyContent:'center',fontSize:'18px',fontWeight:'700',color:sc(agent.avgScore)}}>{agent.grade}</div><div><div style={{fontWeight:'600',color:T.textPrimary,fontSize:'15px'}}>{agent.name}</div><div style={{fontSize:'12px',color:T.textMuted,marginTop:'2px'}}>{agent.count} evaluations</div></div></div><div style={{fontSize:'22px',fontWeight:'700',color:sc(agent.avgScore)}}>{agent.avgScore.toFixed(1)}%</div></div>{agent.strengths.length>0&&<div style={{marginTop:'10px',display:'flex',gap:'6px',flexWrap:'wrap'}}>{agent.strengths.map((s,i)=><span key={i} style={{padding:'4px 10px',background:'rgba(34,197,94,0.1)',borderRadius:'8px',fontSize:'11px',color:T.green}}>{s.skill.replace(/([A-Z])/g,' $1').trim()}: {s.score.toFixed(1)}</span>)}</div>}</div>))}</div>}
              </div>
              {selectedCoachingAgent&&<div style={{...cardStyle,padding:'24px',position:'sticky',top:'20px',maxHeight:'calc(100vh - 200px)',overflowY:'auto'}}>
                <div style={{display:'flex',justifyContent:'space-between',alignItems:'flex-start',marginBottom:'20px'}}><div><h3 style={{margin:'0 0 4px',fontSize:'20px',color:T.textPrimary,fontWeight:'600'}}>{selectedCoachingAgent.name}</h3><div style={{fontSize:'13px',color:T.textMuted}}>{selectedCoachingAgent.count} evaluations</div></div><button onClick={()=>setSelectedCoachingAgent(null)} style={{background:'none',border:'none',color:T.textMuted,cursor:'pointer',fontSize:'20px'}}>√ó</button></div>
                <div style={{display:'flex',alignItems:'center',gap:'16px',marginBottom:'24px',padding:'18px',background:T.cardInner,borderRadius:'14px'}}><div style={{width:'64px',height:'64px',borderRadius:'16px',background:`${sc(selectedCoachingAgent.avgScore)}18`,border:`2px solid ${sc(selectedCoachingAgent.avgScore)}`,display:'flex',alignItems:'center',justifyContent:'center',fontSize:'24px',fontWeight:'700',color:sc(selectedCoachingAgent.avgScore)}}>{selectedCoachingAgent.grade}</div><div><div style={{fontSize:'32px',fontWeight:'700',color:sc(selectedCoachingAgent.avgScore),lineHeight:1}}>{selectedCoachingAgent.avgScore.toFixed(1)}%</div><div style={{fontSize:'12px',color:T.textMuted,marginTop:'4px'}}>Average Score</div></div></div>
                <div style={{marginBottom:'24px'}}><h4 style={{margin:'0 0 14px',fontSize:'14px',color:T.textPrimary,fontWeight:'600'}}>üìä Category Performance</h4><ProgressBar value={selectedCoachingAgent.catAvg.softSkills} color="#ec4899" label="Soft Skills"/><ProgressBar value={selectedCoachingAgent.catAvg.issueUnderstanding} color={T.teal} label="Issue Understanding"/><ProgressBar value={selectedCoachingAgent.catAvg.productProcess} color={T.amber} label="Product & Process"/><ProgressBar value={selectedCoachingAgent.catAvg.toolsUtilization} color={T.blue} label="Tools Utilization"/></div>
                {selectedCoachingAgent.weaknesses.length>0&&<div style={{marginBottom:'24px',padding:'16px',background:'rgba(239,68,68,0.06)',borderRadius:'14px',borderLeft:`3px solid ${T.danger}`}}><h4 style={{margin:'0 0 14px',fontSize:'14px',color:T.danger,fontWeight:'600'}}>üéØ Coaching Focus Areas</h4>{selectedCoachingAgent.weaknesses.map((w,i)=>(<div key={i} style={{marginBottom:'10px',padding:'10px',background:'rgba(255,255,255,0.03)',borderRadius:'10px'}}><div style={{display:'flex',justifyContent:'space-between',marginBottom:'4px'}}><span style={{fontSize:'13px',color:T.textPrimary,fontWeight:'500'}}>{w.skill.replace(/([A-Z])/g,' $1').trim()}</span><span style={{fontSize:'13px',fontWeight:'700',color:T.danger}}>{w.score.toFixed(1)}/5</span></div><div style={{fontSize:'11px',color:T.textMuted}}>Category: {w.category.replace(/([A-Z])/g,' $1').trim()}</div></div>))}</div>}
                {selectedCoachingAgent.recurringIssues?.length>0&&<div style={{marginBottom:'24px',padding:'16px',background:'rgba(251,191,36,0.06)',borderRadius:'14px',borderLeft:`3px solid ${T.amber}`}}><h4 style={{margin:'0 0 14px',fontSize:'14px',color:T.amber,fontWeight:'600'}}>üîÅ Recurring Issues</h4><div style={{fontSize:'11px',color:T.textMuted,marginBottom:'12px'}}>Parameters repeatedly scored ‚â§ 2/5 across multiple evaluations</div>{selectedCoachingAgent.recurringIssues.map((ri,i)=>(<div key={i} style={{marginBottom:'10px',padding:'10px',background:'rgba(255,255,255,0.03)',borderRadius:'10px'}}><div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:'4px'}}><span style={{fontSize:'13px',color:T.textPrimary,fontWeight:'500'}}>{ri.skill.replace(/([A-Z])/g,' $1').trim()}</span><span style={{padding:'3px 10px',borderRadius:'12px',fontSize:'10px',fontWeight:'700',background:'rgba(239,68,68,0.15)',color:T.danger}}>{ri.lowCount}/{ri.totalEvals} low</span></div><div style={{display:'flex',justifyContent:'space-between',alignItems:'center'}}><span style={{fontSize:'11px',color:T.textMuted}}>{ri.category.replace(/([A-Z])/g,' $1').trim()}</span><span style={{fontSize:'11px',color:T.textMuted}}>Avg: <span style={{fontWeight:'700',color:ri.avg<=2?T.danger:T.amber}}>{ri.avg.toFixed(1)}/5</span> ‚Ä¢ {ri.pct}% of evals scored low</span></div></div>))}</div>}
                {selectedCoachingAgent.strengths.length>0&&<div style={{marginBottom:'24px',padding:'16px',background:'rgba(34,197,94,0.06)',borderRadius:'14px',borderLeft:`3px solid ${T.green}`}}><h4 style={{margin:'0 0 14px',fontSize:'14px',color:T.green,fontWeight:'600'}}>üí™ Strengths</h4>{selectedCoachingAgent.strengths.map((s,i)=>(<div key={i} style={{marginBottom:'8px',display:'flex',justifyContent:'space-between',alignItems:'center'}}><span style={{fontSize:'13px',color:T.textPrimary}}>{s.skill.replace(/([A-Z])/g,' $1').trim()}</span><span style={{fontSize:'13px',fontWeight:'700',color:T.green}}>{s.score.toFixed(1)}/5</span></div>))}</div>}
                {selectedCoachingAgent.feedbacks.length>0&&<div><h4 style={{margin:'0 0 14px',fontSize:'14px',color:T.textPrimary,fontWeight:'600'}}>üí¨ Recent Feedback</h4>{selectedCoachingAgent.feedbacks.map((fb,i)=>(<div key={i} style={{marginBottom:'12px',padding:'12px',background:T.cardInner,borderRadius:'10px',borderLeft:`3px solid ${sc(fb.score)}`}}><div style={{display:'flex',justifyContent:'space-between',marginBottom:'6px'}}><span style={{fontSize:'11px',color:T.textMuted}}>{fb.date}</span><span style={{fontSize:'12px',fontWeight:'700',color:sc(fb.score)}}>{fb.score.toFixed(0)}%</span></div><div style={{fontSize:'12px',color:T.textSecondary,lineHeight:'1.5'}}>{fb.feedback}</div>{fb.ticketId&&<a href={`https://osmozone.gorgias.com/app/ticket/${fb.ticketId}`} target="_blank" rel="noopener noreferrer" style={{fontSize:'11px',color:T.tealLight,marginTop:'6px',display:'inline-block'}}>View Ticket ‚Üí</a>}</div>))}</div>}
                {selectedCoachingAgent.violations>0&&<div style={{marginTop:'20px',padding:'14px',background:'rgba(239,68,68,0.1)',borderRadius:'12px',border:'1px solid rgba(239,68,68,0.2)'}}><div style={{fontSize:'13px',color:T.danger,fontWeight:'600'}}>‚ö†Ô∏è {selectedCoachingAgent.violations} Zero Tolerance Violation(s)</div><div style={{fontSize:'11px',color:T.textMuted,marginTop:'4px'}}>Requires immediate attention</div></div>}
                {/* Coaching History */}
                {(()=>{const sessions=coachingSessions.filter(s=>s.agent_name===selectedCoachingAgent.name);return sessions.length>0?(<div style={{marginTop:'20px'}}><h4 style={{margin:'0 0 14px',fontSize:'14px',color:T.textPrimary,fontWeight:'600'}}>üìù Coaching History</h4>{sessions.slice(0,5).map((s,i)=>(<div key={i} style={{marginBottom:'10px',padding:'12px',background:'rgba(34,197,94,0.06)',borderRadius:'10px',borderLeft:`3px solid ${T.green}`}}><div style={{display:'flex',justifyContent:'space-between',marginBottom:'4px'}}><span style={{fontSize:'12px',color:T.green,fontWeight:'600'}}>‚úÖ Coached by {s.coached_by}</span><span style={{fontSize:'11px',color:T.textMuted}}>{new Date(s.created_at).toLocaleDateString()}</span></div>{s.notes&&<div style={{fontSize:'12px',color:T.textSecondary,marginTop:'4px'}}>{s.notes}</div>}</div>))}</div>):null;})()}
                {/* Coaching Done Button */}
                <button onClick={()=>setShowCoachingModal(true)} style={{...btnP,width:'100%',marginTop:'20px',background:T.success,padding:'14px',fontSize:'14px',boxShadow:'0 3px 12px rgba(34,197,94,0.3)'}}>‚úÖ Mark Coaching Done</button>
              </div>}
            </div>
          </>}
        </div>)}

        {/* DISPUTES */}
        {activeTab==='disputes'&&userRole==='team_lead'&&(<div><div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:'22px'}}><div><h2 style={{margin:0,fontSize:'20px',color:T.textPrimary,fontWeight:'600'}}>Disputes</h2><p style={{margin:'4px 0 0',fontSize:'13px',color:T.textMuted}}>Review and resolve agent evaluation disputes</p></div><button onClick={loadDisputes} style={btnS}>üîÑ Refresh</button></div>{disputes.length===0?(<div style={{...cardStyle,textAlign:'center',padding:'70px'}}><div style={{fontSize:'56px',marginBottom:'16px',opacity:0.6}}>‚öñÔ∏è</div><p style={{color:T.textMuted,fontSize:'15px',margin:0}}>No disputes submitted</p></div>):(<>{disputes.filter(d=>d.status==='pending').length>0&&(<div style={{marginBottom:'24px'}}><h3 style={{margin:'0 0 16px',fontSize:'16px',color:T.amber,fontWeight:'600'}}>‚è≥ Pending ({disputes.filter(d=>d.status==='pending').length})</h3>{disputes.filter(d=>d.status==='pending').map(d=>(<div key={d.id} style={{...cardStyle,padding:'20px',marginBottom:'12px'}}><div style={{display:'flex',justifyContent:'space-between',alignItems:'center',flexWrap:'wrap',gap:'12px'}}><div><div style={{fontSize:'15px',fontWeight:'600',color:T.textPrimary}}>{d.agent_name}</div><div style={{fontSize:'12px',color:T.textMuted,marginTop:'3px'}}>Ticket #{d.ticket_id} ‚Ä¢ {new Date(d.created_at).toLocaleDateString()}</div></div><div style={{display:'flex',alignItems:'center',gap:'12px'}}><div style={{textAlign:'right'}}><div style={{fontSize:'18px',fontWeight:'700',color:sc(d.original_final_score||0)}}>{(d.original_final_score||0).toFixed(1)}%</div><div style={{fontSize:'11px',color:T.textMuted}}>Original Score</div></div><button onClick={()=>{setSelectedDispute(d);setDisputeReviewNotes('');}} style={{...btnP,padding:'10px 20px',fontSize:'13px',background:T.amber}}>Review</button><button onClick={()=>cancelDispute(d.id)} style={{...btnS,padding:'10px 16px',fontSize:'13px',color:T.textMuted}}>Cancel</button></div></div><div style={{marginTop:'12px',padding:'12px',background:'rgba(245,158,11,0.06)',borderRadius:'10px',borderLeft:`3px solid ${T.amber}`,fontSize:'13px',color:T.textSecondary,lineHeight:'1.6'}}>{d.reason}</div></div>))}</div>)}{disputes.filter(d=>d.status!=='pending').length>0&&(<div><h3 style={{margin:'0 0 16px',fontSize:'16px',color:T.textSecondary,fontWeight:'600'}}>Resolved ({disputes.filter(d=>d.status!=='pending').length})</h3>{disputes.filter(d=>d.status!=='pending').map(d=>(<div key={d.id} style={{...cardStyle,padding:'20px',marginBottom:'12px',opacity:0.8}}><div style={{display:'flex',justifyContent:'space-between',alignItems:'center',flexWrap:'wrap',gap:'12px'}}><div><div style={{fontSize:'15px',fontWeight:'600',color:T.textPrimary}}>{d.agent_name}</div><div style={{fontSize:'12px',color:T.textMuted,marginTop:'3px'}}>Ticket #{d.ticket_id} ‚Ä¢ {new Date(d.created_at).toLocaleDateString()}</div></div><div style={{display:'flex',alignItems:'center',gap:'12px'}}><span style={{padding:'5px 14px',borderRadius:'20px',fontSize:'12px',fontWeight:'600',background:d.status==='accepted'?'rgba(34,197,94,0.15)':'rgba(239,68,68,0.15)',color:d.status==='accepted'?T.green:T.danger}}>{d.status==='accepted'?'‚úÖ Accepted':'‚ùå Rejected'}</span></div></div>{d.reviewer_notes&&<div style={{marginTop:'12px',padding:'12px',background:T.cardInner,borderRadius:'10px',fontSize:'13px',color:T.textSecondary}}><span style={{fontWeight:'600',color:T.textPrimary}}>Reviewer ({d.reviewer_name}):</span> {d.reviewer_notes}</div>}</div>))}</div>)}</>)}</div>)}

        {/* GRADE */}
        {activeTab==='grade'&&(<>
          {/* Past Evaluations - Compact sidebar display */}
          {pastEvaluations.length>0&&!analysisComplete&&(<div style={{marginBottom:'20px'}}>
            {pastEvaluations.map((pe,idx)=>(<div key={pe.id} style={{...cardStyle,marginBottom:'12px',overflow:'hidden'}}>
              {/* Compact summary - always visible */}
              <div onClick={()=>setShowPastDetail(showPastDetail===pe.id?null:pe.id)} style={{padding:'16px 18px',cursor:'pointer',transition:'all 0.2s'}}>
                <div style={{display:'flex',alignItems:'center',justifyContent:'space-between',marginBottom:'10px'}}>
                  <div style={{display:'flex',alignItems:'center',gap:'6px'}}><span style={{fontSize:'12px'}}>üìä</span><span style={{fontSize:'11px',color:T.textMuted,fontWeight:'600',textTransform:'uppercase',letterSpacing:'0.5px'}}>Evaluation {pastEvaluations.length>1?`${idx+1}/${pastEvaluations.length}`:''}</span></div>
                  <div style={{fontSize:'11px',color:T.textMuted}}>{pe.date}{pe.autoGraded&&<span style={{marginLeft:'6px',background:'rgba(245,158,11,0.15)',color:T.amber,padding:'2px 7px',borderRadius:'6px',fontSize:'9px',fontWeight:'700'}}>AUTO</span>}</div>
                </div>
                <div style={{display:'flex',alignItems:'center',gap:'14px'}}>
                  <div style={{width:'52px',height:'52px',borderRadius:'14px',background:`${sc(pe.finalScore)}15`,border:`2px solid ${sc(pe.finalScore)}`,display:'flex',alignItems:'center',justifyContent:'center',fontSize:'22px',fontWeight:'700',color:sc(pe.finalScore)}}>{pe.grade}</div>
                  <div style={{flex:1}}>
                    <div style={{display:'flex',alignItems:'baseline',gap:'8px'}}><span style={{fontSize:'26px',fontWeight:'700',color:sc(pe.finalScore),lineHeight:1}}>{pe.finalScore.toFixed(1)}%</span></div>
                    <div style={{fontSize:'13px',color:T.textPrimary,fontWeight:'500',marginTop:'2px'}}>{pe.agentName}</div>
                    <div style={{fontSize:'11px',color:T.textMuted,marginTop:'1px'}}>by {pe.evaluatorName}</div>
                  </div>
                  <div style={{color:T.textMuted,fontSize:'18px',transform:showPastDetail===pe.id?'rotate(90deg)':'none',transition:'transform 0.2s'}}>‚Ä∫</div>
                </div>
                {/* Mini category bars - always visible */}
                <div style={{display:'grid',gridTemplateColumns:'repeat(4,1fr)',gap:'6px',marginTop:'12px'}}>
                  {[{l:'Soft',v:pe.scores?.softSkills?.categoryScore||0,c:'#ec4899'},{l:'Issue',v:pe.scores?.issueUnderstanding?.categoryScore||0,c:T.teal},{l:'Process',v:pe.scores?.productProcess?.categoryScore||0,c:T.amber},{l:'Tools',v:pe.scores?.toolsUtilization?.categoryScore||0,c:T.blue}].map((cat,ci)=>(<div key={ci}><div style={{display:'flex',justifyContent:'space-between',marginBottom:'3px'}}><span style={{fontSize:'9px',color:T.textMuted,fontWeight:'600'}}>{cat.l}</span><span style={{fontSize:'9px',color:cat.c,fontWeight:'700'}}>{cat.v.toFixed(0)}%</span></div><div style={{height:'4px',background:T.ratingOff,borderRadius:'2px',overflow:'hidden'}}><div style={{height:'100%',width:`${Math.min(cat.v,100)}%`,background:cat.c,borderRadius:'2px'}}></div></div></div>))}
                </div>
              </div>
              {/* Expanded details */}
              {showPastDetail===pe.id&&(<div style={{borderTop:`1px solid ${T.border}`,padding:'16px 18px'}}>
                {/* Detailed category scores */}
                {[{title:'Soft Skills',icon:'üí¨',color:'#ec4899',data:pe.scores?.softSkills,fields:[{k:'tone',l:'Tone'},{k:'empathy',l:'Empathy'},{k:'professionalism',l:'Prof.'},{k:'clarity',l:'Clarity'}]},
                  {title:'Issue Understanding',icon:'üîç',color:T.teal,data:pe.scores?.issueUnderstanding,fields:[{k:'correctIdentification',l:'ID'},{k:'rootCauseAnalysis',l:'Root'},{k:'customerContext',l:'Context'},{k:'escalationRecognition',l:'Esc.'}]},
                  {title:'Product & Process',icon:'üìã',color:T.amber,data:pe.scores?.productProcess,fields:[{k:'policyAccuracy',l:'Policy'},{k:'sopAdherence',l:'SOP'},{k:'solutionCorrectness',l:'Solution'},{k:'escalationProcess',l:'Process'}]},
                  {title:'Tools Utilization',icon:'üõ†Ô∏è',color:T.blue,data:pe.scores?.toolsUtilization,fields:[{k:'gorgiasUsage',l:'Gorgias'},{k:'internalNotes',l:'Notes'},{k:'shopifyUsage',l:'Shopify'}]}
                ].map((cat,ci)=>(<div key={ci} style={{marginBottom:'12px',padding:'12px',background:T.cardInner,borderRadius:'10px'}}>
                  <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:'8px'}}><span style={{fontSize:'12px',color:T.textPrimary,fontWeight:'600'}}>{cat.icon} {cat.title}</span><span style={{fontSize:'13px',fontWeight:'700',color:cat.color}}>{(cat.data?.categoryScore||0).toFixed(0)}%</span></div>
                  <div style={{display:'flex',gap:'4px',flexWrap:'wrap'}}>{cat.fields.map((f,fi)=>{const val=cat.data?.[f.k]||0;return(<div key={fi} style={{flex:'1 1 auto',minWidth:'50px',textAlign:'center',padding:'6px 4px',background:'rgba(255,255,255,0.03)',borderRadius:'6px'}}><div style={{fontSize:'8px',color:T.textMuted,fontWeight:'600',textTransform:'uppercase'}}>{f.l}</div><div style={{display:'flex',justifyContent:'center',gap:'2px',marginTop:'4px'}}>{[1,2,3,4,5].map(n=>(<div key={n} style={{width:'8px',height:'8px',borderRadius:'2px',background:val>=n?cat.color:T.ratingOff}}></div>))}</div><div style={{fontSize:'10px',color:cat.color,fontWeight:'700',marginTop:'2px'}}>{val}/5</div></div>);})}</div>
                  {/* Show explanations if available */}
                  {cat.data?.explanations&&Object.entries(cat.data.explanations).some(([,v])=>v)&&(<div style={{marginTop:'8px'}}>{cat.fields.map((f,fi)=>{const exp=cat.data?.explanations?.[f.k];if(!exp)return null;return(<div key={fi} style={{fontSize:'11px',color:T.textSecondary,padding:'6px 8px',background:'rgba(255,255,255,0.02)',borderRadius:'6px',marginTop:'4px',borderLeft:`2px solid ${cat.color}40`}}><span style={{fontWeight:'600',color:T.textPrimary}}>{f.l}:</span> {exp}</div>);})}</div>)}
                </div>))}
                {/* Feedback */}
                {pe.suggestedResponse&&(<div style={{padding:'12px',background:'rgba(34,197,94,0.06)',borderRadius:'10px',marginBottom:'10px',borderLeft:`3px solid ${T.green}`}}><div style={{fontSize:'10px',color:T.green,fontWeight:'600',textTransform:'uppercase',marginBottom:'6px',letterSpacing:'0.5px'}}>Suggested Response</div><div style={{fontSize:'12px',color:T.textSecondary,lineHeight:'1.7'}}>{pe.suggestedResponse}</div></div>)}
                {pe.comments&&(<div style={{padding:'12px',background:T.cardInner,borderRadius:'10px',marginBottom:'10px',borderLeft:`3px solid ${T.teal}`}}><div style={{fontSize:'10px',color:T.textMuted,fontWeight:'600',textTransform:'uppercase',marginBottom:'6px',letterSpacing:'0.5px'}}>Feedback</div><div style={{fontSize:'12px',color:T.textSecondary,lineHeight:'1.7'}}>{pe.comments}</div></div>)}
                {/* AI Reasoning */}
                {pe.aiReasoning&&(<div style={{padding:'12px',background:'rgba(59,130,246,0.06)',borderRadius:'10px',borderLeft:`3px solid ${T.blue}`}}><div style={{fontSize:'10px',color:T.blue,fontWeight:'600',textTransform:'uppercase',marginBottom:'6px',letterSpacing:'0.5px'}}>ü§ñ AI Analysis</div><div style={{fontSize:'11px',color:T.textSecondary,lineHeight:'1.7'}}>{pe.aiReasoning}</div></div>)}
              </div>)}
            </div>))}
            {/* Re-grade divider */}
            <div style={{display:'flex',alignItems:'center',gap:'12px',margin:'8px 0'}}><div style={{flex:1,height:'1px',background:T.border}}></div><span style={{fontSize:'11px',color:T.textMuted,fontWeight:'600',textTransform:'uppercase',letterSpacing:'0.5px'}}>New Evaluation</span><div style={{flex:1,height:'1px',background:T.border}}></div></div>
          </div>)}

          {!analysisComplete?(<div style={{...cardStyle,padding:'36px'}}><div style={{marginBottom:'28px'}}><label style={{...labelStyle,fontSize:'13px',marginBottom:'10px'}}>Evaluator *</label><select value={evaluatorName} onChange={e=>setEvaluatorName(e.target.value)} style={{...selectStyle,width:'100%'}}><option value="">Select evaluator...</option>{evaluators.map(e=><option key={e} value={e}>{e}</option>)}</select></div>{ticketData?.id&&(<div style={{padding:'20px',background:'rgba(20,184,166,0.08)',borderRadius:'14px',marginBottom:'28px',borderLeft:`3px solid ${T.teal}`}}><div style={{fontSize:'15px',color:T.tealLight,fontWeight:'600'}}>Ticket #{ticketData.id}</div>{ticketMessages.length>0&&<div style={{fontSize:'13px',color:T.textSecondary,marginTop:'6px'}}>{ticketMessages.length} messages ‚Ä¢ {agents.length} agent(s)</div>}</div>)}{agents.length>0&&(<div style={{marginBottom:'28px'}}><label style={labelStyle}>Detected Agents</label><div style={{display:'flex',flexWrap:'wrap',gap:'8px'}}>{agents.map(a=><span key={a} style={{padding:'10px 18px',background:T.cardInner,borderRadius:'10px',fontSize:'13px',color:T.tealLight,fontWeight:'500',border:`1px solid ${T.border}`}}>{a}</span>)}</div></div>)}<button onClick={analyzeTicket} disabled={isAnalyzing||!evaluatorName||ticketMessages.length===0} style={{...btnP,width:'100%',padding:'18px',fontSize:'15px',opacity:(isAnalyzing||!evaluatorName||ticketMessages.length===0)?0.4:1}}>{isAnalyzing?'‚è≥ Analyzing...':'ü§ñ Analyze Ticket'}</button></div>):(<>{agentEvaluations.length>1&&(<div style={{...cardStyle,padding:'20px',marginBottom:'20px'}}><label style={labelStyle}>Agents ({agentEvaluations.length})</label><div style={{display:'flex',gap:'8px',flexWrap:'wrap'}}>{agentEvaluations.map((a,i)=><button key={i} onClick={()=>switchAgent(i)} style={{...btnS,background:currentAgentIndex===i?T.tabActive:T.tabInactive,color:currentAgentIndex===i?'#fff':T.textSecondary,border:currentAgentIndex===i?'none':`1px solid ${T.border}`}}>{a.agentName||`Agent ${i+1}`}</button>)}</div></div>)}<div style={{...cardStyle,padding:'24px',marginBottom:'20px'}}><label style={labelStyle}>Agent Name</label><input value={agentName} onChange={e=>setAgentName(e.target.value)} style={inputStyle}/>{isEscalationAgent&&<div style={{marginTop:'12px',padding:'12px 16px',background:'rgba(245,158,11,0.1)',borderRadius:'10px',fontSize:'13px',color:T.amber,borderLeft:`3px solid ${T.amber}`}}>üî∂ Escalation Agent</div>}</div>{aiReasoning&&(<div style={{...cardStyle,padding:'24px',marginBottom:'20px'}}><label style={{...labelStyle,color:T.tealLight}}>ü§ñ AI Analysis</label><div style={{fontSize:'13px',color:T.textSecondary,lineHeight:'1.8'}}>{aiReasoning}</div></div>)}{detectedBuzzwords.length>0&&!isEscalationAgent&&(<div style={{...cardStyle,padding:'24px',marginBottom:'20px',borderLeft:`3px solid ${T.danger}`}}><div style={{fontSize:'15px',color:T.danger,fontWeight:'600',marginBottom:'14px'}}>üö® Zero Tolerance Buzzwords</div><div style={{display:'flex',flexWrap:'wrap',gap:'8px',marginBottom:'16px'}}>{detectedBuzzwords.map((b,i)=><span key={i} style={{padding:'7px 14px',background:'rgba(239,68,68,0.12)',borderRadius:'14px',fontSize:'12px',color:T.danger,fontWeight:'600'}}>{b}</span>)}</div><button onClick={()=>setZeroToleranceViolation(!zeroToleranceViolation)} style={{...btnS,background:zeroToleranceViolation?T.danger:'rgba(239,68,68,0.12)',color:zeroToleranceViolation?'#fff':T.danger,border:'none'}}>{zeroToleranceViolation?'‚úì Flagged':'Flag Violation'}</button></div>)}{!zeroToleranceViolation&&(<><GradeCategory title="Soft Skills" weight={20} icon="üí¨" color="#ec4899" scores={softSkills} setScores={setSoftSkills} explanations={softSkillsExp} fields={[{key:'tone',label:'Tone'},{key:'empathy',label:'Empathy'},{key:'professionalism',label:'Professionalism'},{key:'clarity',label:'Clarity'}]}/><GradeCategory title="Issue Understanding" weight={30} icon="üîç" color={T.teal} scores={issueUnderstanding} setScores={setIssueUnderstanding} explanations={issueUnderstandingExp} fields={[{key:'correctIdentification',label:'Issue Identification'},{key:'rootCauseAnalysis',label:'Root Cause Analysis'},{key:'customerContext',label:'Context Awareness'},{key:'escalationRecognition',label:'Escalation Recognition'}]}/><GradeCategory title="Product & Process" weight={30} icon="üìã" color={T.amber} scores={productProcess} setScores={setProductProcess} explanations={productProcessExp} fields={[{key:'policyAccuracy',label:'Policy Accuracy'},{key:'sopAdherence',label:'SOP Adherence'},{key:'solutionCorrectness',label:'Solution Quality'},{key:'escalationProcess',label:'Escalation Process'}]}/><GradeCategory title="Tools Utilization" weight={20} icon="üõ†Ô∏è" color={T.blue} scores={toolsUtilization} setScores={setToolsUtilization} explanations={toolsUtilizationExp} fields={[{key:'gorgiasUsage',label:'Gorgias Usage'},{key:'internalNotes',label:'Internal Notes'},{key:'shopifyUsage',label:'Shopify Usage'}]}/></>)}<div style={{...cardStyle,padding:'24px',marginBottom:'20px'}}><label style={labelStyle}>Feedback</label><textarea value={comments} onChange={e=>setComments(e.target.value)} placeholder="Enter feedback..." style={{...inputStyle,height:'110px',resize:'none'}}/></div><div style={{...cardStyle,padding:'36px',marginBottom:'20px',textAlign:'center'}}><label style={{...labelStyle,textAlign:'center'}}>Final Score</label><div style={{display:'flex',justifyContent:'center',alignItems:'center',gap:'24px',margin:'20px 0 30px'}}><div style={{fontSize:'64px',fontWeight:'700',color:zeroToleranceViolation?T.danger:sc(finalScore),lineHeight:1}}>{finalScore.toFixed(1)}%</div><div style={{width:'82px',height:'82px',borderRadius:'20px',background:`${zeroToleranceViolation?T.danger:sc(finalScore)}18`,border:`3px solid ${zeroToleranceViolation?T.danger:sc(finalScore)}`,display:'flex',alignItems:'center',justifyContent:'center',fontSize:'34px',fontWeight:'700',color:zeroToleranceViolation?T.danger:sc(finalScore)}}>{zeroToleranceViolation?'F':gr(finalScore)}</div></div>{!zeroToleranceViolation&&(<div style={{display:'grid',gridTemplateColumns:'repeat(4,1fr)',gap:'12px',marginBottom:'30px'}}>{[{l:'Soft Skills',s:calcScore(softSkills),c:'#ec4899'},{l:'Issue',s:calcScore(issueUnderstanding),c:T.teal},{l:'Process',s:calcScore(productProcess),c:T.amber},{l:'Tools',s:calcScore(toolsUtilization),c:T.blue}].map((c,i)=>(<div key={i} style={{padding:'16px',background:T.cardInner,borderRadius:'12px'}}><div style={{fontSize:'11px',color:T.textMuted,marginBottom:'6px'}}>{c.l}</div><div style={{fontSize:'26px',fontWeight:'700',color:c.c}}>{c.s.toFixed(0)}%</div></div>))}</div>)}<div style={{display:'flex',gap:'12px',justifyContent:'center'}}><button onClick={saveResult} disabled={saveStatus==='saving'} style={{...btnP,padding:'16px 42px',fontSize:'15px',background:T.success,opacity:saveStatus==='saving'?0.5:1,boxShadow:'0 3px 12px rgba(34,197,94,0.3)'}}>{saveStatus==='saving'?'Saving...':saveStatus==='saved'?'‚úì Saved!':'üíæ Save Evaluation'}</button><button onClick={resetForm} style={{...btnS,padding:'16px 30px',fontSize:'15px'}}>Reset</button></div></div></>)}</>)}
      </div>
    </div>
  );
}
